function mod_migrations(h,f){var c=mod_helper();var d=mod_design_element_structure();var g=h;var k=f;var i={"2013-12-18T16:39:47":function(l){j(l,"number_of_lines_setting")},"2013-12-19T13:49:57":function(l){j(l,"grid_size_setting")},"2014-01-24T20:45:49":function(l){j(l,"allow_new_cards")},"2014-01-25T09:32:33":function(l){j(l,"user_enabled_setting")},"2014-01-25T11:34:18":function(l){j(l,"label_multilanguage_key")},"2014-02-10T09:10:55":function(l){j(l,"label_multilanguage_key")},"2014-02-11T09:47:26":function(l){j(l,"parent_application_setting")},"2014-02-18T18:25:23":function(l){j(l,"couchdb_viewname")},"2014-02-25T16:53:25":function(l){if("readonly" in l){delete l.readonly}},"2014-02-25T20:59:06":function(l){j(l,"help_text")},"2014-03-05T10:52:20":function(m){if(m.definition_type!=="User"){return}var l=m.get_value("assigned_roles",[]);if(m.get_value("is_enviroment_manager_setting")===true&&l.indexOf("&&systemRole")===-1){l.push("&&systemRole");if(!(m.set_design_element_value("assigned_roles",l,false))){k.log("could not add a new role - element on user Card not found",LOG_LEVEL.error)}m.roles=c.clone(l)}},"2014-03-07T09:36:12":function(l){if(g.application_key==="roles"&&l._id==="&&applicationProperties"){delete l.design_elements}},"2014-04-28T22:00:00":function(m){if(m.definition_type==="Proto"&&m.hidden===true){delete m.hidden}if(m.definition_type==="TableView"){var l=m.get_design_element("application_setting");if(l!==null&&(typeof(l.value)!=="string"||l.value==="")){l.value=g.application_key}}},"2014-04-29T13:08:33":function(m){j(m,"hidden");if(m.definition_type==="RelationField"){var l=0;var o=1;var p=m.get_design_element("cardinality_setting");if(!(c.is_empty(p))){o=p.value}var q=false;var n=m.get_design_element("allow_new_cards");if(!(c.is_empty(n))){q=n.value}if(o===2&&q===true){l=2}else{if(o===2){l=1}}m.set_design_element_value("presentation_setting",l)}},"2014-05-15T09:33:43":function(m){j(m,"couchdb_viewname");if(m.definition_type==="Proto"){var l=m.get_design_element("cards_based_on_this");if(l!==null){l.entity_proto_setting=m._id}}},"2014-05-15T22:12:43":function(l){j(l,"requirement_setting");j(l,"hidden")},"2014-09-02T05:02:45":function(l){j(l,"user_creatable")},"2015-02-11T15:05:19":function(l){if(l._id==="&&applicationProperties"){j(l,"grid_size_setting");l.design_elements=c.get_purged_list("languages",l.design_elements)}if(l._id==="&&multilanguageProto"){l.design_elements=c.get_purged_list("card_design_elements",l.design_elements)}if(l.proto_key==="&&multilanguageProto"){var m=l.get_value("en_US");if(typeof(m)!=="string"){m=""}l.design_elements=[{definition_key:"en",value:m}]}},"2015-02-27T03:07:55":function(m){if(m.proto_key==="&&multilanguageProto"){var l=m.set_element_value("en_US","",false);if(l===true){k.log("cleared 'en_US' in ML Definition with ID "+m._id+". (upgrade to Protogrid 1.0)",LOG_LEVEL.message)}}}};var e=Object.keys(i).sort();function j(n,l){if(!(Array.isArray(n.design_elements))){return}for(var o=0;o<n.design_elements.length;o++){var m=n.design_elements[o];if(l in m){delete m[l]}}return}function a(){return e[e.length-1]}function b(n){if(n.last_healed>=a()){return}for(var l=0;l<e.length;l++){if(n.last_healed>=e[l]){continue}var o=i[e[l]];o(n)}return}return{migrate_card:b}}function mod_card_tools(aA,d,ar,Z,M){var H=Z;var D=M;var T=mod_helper(D);var p=mod_design_element_structure();var X=mod_card_structure();var o=aA;var A=d;var ai=mod_migrations(A,H);var ag=[];var O=aN();var aL=c(O,ar);var S=aa(ar,ag);var ax=n();var J=null;function F(i){if(i.get_value!==undefined&&i._id==="&&multilanguageProto"){}T.remove_property(i,"get_key");T.remove_property(i,"get_type");T.remove_property(i,"get_proto_key");T.remove_property(i,"get_design_element");T.remove_property(i,"get_value");T.remove_property(i,"set_design_element_value");T.remove_property(i,"get_design_element_properties");T.remove_property(i,"temporary_data");if("temporary_data" in i){H.log("temporary_data could not be removed from card "+i._id,LOG_LEVEL.error)
}}function a(i){i.get_key=function(){return this._id};i.get_type=function(){return x(this)};i.get_proto_key=function(){return this.proto_key};i.get_design_element=function(aP){var aQ=G(this);if(typeof(aQ[aP])!=="object"||aQ[aP]===null){return null}return aQ[aP]};i.get_value=function(aR,aP){if(aP===undefined){aP=null}if(aR in this){return this[aR]}var aQ=this.get_design_element(aR);if(aQ===null){return aP}return aQ.value};i.get_shortname=function(){return ao(this)};i.set_design_element_value=function(aR,aS,aP){if(typeof(aP)!=="boolean"){aP=true}var aQ=this.get_design_element(aR);if(aQ===null&&aP===false){this.design_elements.push({name:aR,value:aS});return true}else{if(aQ===null){return false}}aQ.value=aS;return true};i.set_element_value=function(aQ,aR,aP){return this.set_design_element_value(aQ,aR,aP)};i.get_design_element_properties=function(aQ){var aP=this.get_design_element(aQ);if(aP===null){return null}return z(aP)};return i}function n(){var aP=Object.keys(LANGUAGE_BY_LOCALE);var aR=[];for(var aQ=0;aQ<aP.length;aQ++){if(aP[aQ].indexOf("_")!==-1){continue}aR.push(aP[aQ])}return aR}function aN(){var i=null;if(!(T.is_empty(system_templates_by_key[A.application_key]))){i=system_templates_by_key[A.application_key]}else{i=mod_minimal_template()}return i}function c(aZ,a1){function a0(a4,a3,a5,i,a6){foreign_template_card=a5[a4];i[a4]=foreign_template_card;foreign_template_card.persistent=false;a1[a4]=foreign_template_card;a6[a4]=a3}var a2=T.merge(aZ.readonly_cards_by_key,aZ.editable_cards_by_key);var aS=null;var aU=Object.keys(a1);var aV={};var aY=null;for(var aT=0;aT<aU.length;aT++){if(aU[aT].indexOf("&&")==-1){continue}if(aU[aT] in a2){continue}if(aS===null){aS=Object.keys(system_templates_by_key)}for(var aR=0;aR<aS.length;aR++){aY=system_templates_by_key[aS[aR]];if(aU[aT] in aY.readonly_cards_by_key){a0(aU[aT],aY,aY.readonly_cards_by_key,a2,aV);break}if(aU[aT] in aY.editable_cards_by_key){a0(aU[aT],aY,aY.editable_cards_by_key,a2,aV);break}}}var aW=Object.keys(aV);for(var aQ=0;aQ<aW.length;aQ++){aY=aV[aW[aQ]];var aX=a1[aW[aQ]];var aP=aX.proto_key;if(typeof(aP)==="string"&&aP!==""){if(aP in aY.readonly_cards_by_key){a0(aP,aY,aY.readonly_cards_by_key,a2,aV);continue}if(aP in aY.editable_cards_by_key){a0(aP,aY,aY.editable_cards_by_key,a2,aV);continue}}}return a2}function ac(aP){if(Array.isArray(aP.design_elements)){aP.design_elements=T.compact(aP.design_elements);for(var aQ=0;aQ<aP.design_elements.length;aQ++){var aR=T.get_property(aP.design_elements[aQ],"value");if(Array.isArray(aR)){aP.design_elements[aQ].value=T.compact(aR)}}}else{aP.design_elements=[]}}function aa(a1,a0){if(a0===undefined){a0=[]}var aY=a1;var aP=Object.keys(aL);for(var aU=0;aU<aP.length;aU++){var aZ=aP[aU];var aR=null;var aV=false;if(aZ in aY){aR=aY[aZ];var aX=x(aL[aZ]);if(aX==="DynamicCard"){aR.proto_key=aL[aZ].proto_key}else{aR.definition_type=aL[aZ].definition_type}}else{aR=aL[aZ]}ac(aR);var aQ=x(aR);if(aQ===null){var aS=aL[aZ];if(aS.definition_type!==undefined){aR.definition_type=aS.definition_type}if(aS.proto_key!==undefined){aR.proto_key=aS.proto_key}aQ=x(aR);if(aQ===null){H.log("template card with id "+aZ+" is of unknown type. cannot fix.",LOG_LEVEL.error);continue}aV=true}if(typeof(aR.last_healed)==="string"&&aR.last_healed<STRUCTURE_VERSION){ai.migrate_card(a(aR));aV=true}var aT=aR;if(typeof(aT.last_healed)!=="string"||aT.last_healed<STRUCTURE_VERSION){var aW=T.extend(X[aQ],aL[aZ]);if(aW.readonly===true){aT=aW}else{aT=T.extend(aW,aR)}aT.last_healed=STRUCTURE_VERSION;aV=true}aL[aZ]=aT;aY[aZ]=aT;if(aV===true){a0.push(aT)}}return aY}function aO(){var i=aN();return Object.keys(i.editable_cards_by_key).concat(Object.keys(i.readonly_cards_by_key))}function an(){return ag}function E(aP,i){if(i.user_creatable===true){aP.push(i)}}function az(aV){var aX=[];var aR=[];var aY=aV+"Definition";var aU=X[aY];if(aU===undefined){H.log("no structure found with name "+aY,LOG_LEVEL.error);return aR}var aT=0;aX[aT]=[aY];E(aR,aU);var aQ=Object.keys(X);while(aX[aT].length>0){aT+=1;
aX[aT]=[];for(var aS=0;aS<aQ.length;aS++){var aW=X[aQ[aS]];var aP=aW.__proto__.definition_type;if(typeof(aP)==="string"&&aX[aT-1].indexOf(aP+"Definition")!==-1){aX[aT].push(aQ[aS]);E(aR,aW)}}}return aR}function aE(aQ,i){if(T.is_empty(aQ)){return{}}var aR=G(aQ);var aP=aR[i];return z(aP)}function aj(aS){var aV={};if(typeof(aS.proto_key)==="string"&&aS.proto_key!==""){aV[aS.proto_key]=["#"]}if(!(Array.isArray(aS.design_elements))){return aV}for(var aT=0;aT<aS.design_elements.length;aT++){var aR=aS.design_elements[aT];var aQ=I(aR);if(aQ===null){continue}var aP=z(aR);if(aP.deleted===true){continue}if(typeof(aP.parent_entity_proto_setting)==="string"&&aP.parent_entity_proto_setting!==""){var aU=aV[aP.parent_entity_proto_setting];if(!(Array.isArray(aU))){aV[aP.parent_entity_proto_setting]=[aQ]}else{aU.push(aQ)}}}return aV}function g(){var aP=o.user_card;if(T.is_empty(aP)){return false}if(aP.roles.indexOf("&&systemRole")!==-1){return true}if(T.is_empty(A.properties)){return false}var i=G(A.properties);if(!(T.is_empty(i,"full_access_role"))&&i.full_access_role.value!==""){return ah().indexOf(i.full_access_role.value)!==-1}return false}function ah(){var aP=o.user_card;var i=G(aP);if(T.is_empty(i.assigned_roles)){return[]}if(typeof(i.assigned_roles.value)==="string"){return[i.assigned_roles.value]}if(!(Array.isArray(i.assigned_roles.value))){return[]}return i.assigned_roles.value}function u(i){if(i.indexOf("org.couchdb.user:")===-1){return"org.couchdb.user:"+i}else{return i}}function at(aR){var aX=[];var aS=ak(aR,"user");aX.push(u(aS));var aP=G(aR);var aQ=aj(aR);var aW=aQ.UserDefinition;if(Array.isArray(aW)){for(var aU=0;aU<aW.length;aU++){var aV=aP[aW[aU]];if(Array.isArray(aV.value)){for(var aT=0;aT<aV.value.length;aT++){aX.push(u(aV.value[aT]))}}else{if(typeof(aV.value)==="string"&&aV.value!==""){aX.push(u(aV.value))}}}}return aX}function af(aP,aT){var aV={};aV=G(aT);var aW=null;if(!(T.is_empty(aV.show_cards_to_users))){aW=aV.show_cards_to_users.value}var i=null;if(!(T.is_empty(aV.allow_editing_cards_to_users))){i=aV.allow_editing_cards_to_users.value}var aU=null;if(!(T.is_empty(aV.editor_role))){aU=aV.editor_role.value}var aQ=null;if(!(T.is_empty(aV.creator_role))){aQ=aV.creator_role.value}var aR={};if(!(T.is_empty(aP.denormalized))){aR=aP.denormalized}var aS={};if(!(T.is_empty(aR[aP.proto_key]))){aS=aR[aP.proto_key]}aS=T.merge(aS,{show_cards_to_users:aW,editor_role:aU,allow_editing_cards_to_users:i,creator_role:aQ});aR[aP.proto_key]=aS;aP.denormalized=aR}function aJ(aR,aP){if(typeof(aP)!=="boolean"){aP=false}if(g()){return true}if(T.is_empty(aR)){if(aP){H.log("no proto found and you are not admin - can't create new card",LOG_LEVEL.warning)}return false}var aQ=G(aR);var i="";if(!(T.is_empty(aQ.editor_role))&&typeof(aQ.editor_role.value)==="string"){i=aQ.editor_role.value}if(i===""){return true}var aT=ah();if(aT.indexOf(i)!==-1){return true}var aS="";if(!(T.is_empty(aQ.creator_role))&&typeof(aQ.creator_role.value)==="string"){aS=aQ.creator_role.value}if(aS===""){if(aP){H.log("you don't have the creator role - can't create new card",LOG_LEVEL.warning)}return false}if(aT.indexOf(aS)!==-1){return true}if(aP){H.log("all security checks have failed for you - can't create new card",LOG_LEVEL.warning)}return false}function s(aS,aU,aQ,aV){if(typeof(aQ)!=="boolean"){aQ=true}if(typeof(aV)!=="boolean"){aV=false}if(!(T.is_empty(aS))&&aS.readonly===true){if(aQ){H.log("the card is readonly - can't edit",LOG_LEVEL.warning)}return false}if(!(T.is_empty(aS))&&aS.persistent===false){if(aQ){H.log("card not persistent - you can edit",LOG_LEVEL.warning)}return true}if(g()){if(aQ){H.log("you're admin",LOG_LEVEL.warning)}return true}if(!(T.is_empty(aS))&&aS.definition_type==="User"&&aS._id===o.user_card._id){return true}if(!(T.is_empty(aS))&&aS.definition_type==="ApplicationProperties"&&typeof(A.application_key)!=="string"){return true}if(T.is_empty(aU)){if(aQ){H.log("no proto found, can't edit card",LOG_LEVEL.warning)}return false}if(aV===true){if(aQ){H.log("new card - checking creation permissions",LOG_LEVEL.warning)
}return aJ(aU,aQ)}var aT=G(aU);var i="";if(!(T.is_empty(aT.editor_role))&&typeof(aT.editor_role.value)==="string"){i=aT.editor_role.value}if(i===""){if(aQ){H.log("no editor set - you can edit",LOG_LEVEL.warning)}return true}if(ah().indexOf(i)!==-1){if(aQ){H.log("you're editor",LOG_LEVEL.warning)}return true}var aR=0;if(!(T.is_empty(aT.allow_editing_cards_to_users))&&typeof(aT.allow_editing_cards_to_users.value)==="number"){aR=aT.allow_editing_cards_to_users.value}if(aR===1){if(aQ){H.log("you're not editor and cards with proto "+aU._id+" can only edited by editors",LOG_LEVEL.warning)}return false}var aP=o.user_id;if(typeof(aP)!=="string"||aP===""){if(aQ){H.log("you can't edit the card - no user id found!",LOG_LEVEL.warning)}return false}aP=u(aP);if(!(T.is_empty(aS))&&at(aS).indexOf(aP)!==-1){if(aQ){H.log("you're a related user and you can edit",LOG_LEVEL.warning)}return true}if(aQ){H.log("you can't edit the card - all security checks have failed to give you permission",LOG_LEVEL.warning)}return false}function l(aP,aR,i,aT){if(typeof(i)!=="boolean"){i=true}if(typeof(aT)!=="boolean"){aT=false}if(g()){return false}if(aP.hidden===true){if(i){H.log("hidden flag is enabled.",LOG_LEVEL.message)}return true}var aU={};if(!(T.is_empty(aR))){aU=G(aR)}var aV=0;if(typeof(aP.show_cards_to_users)==="number"){aV=aP.show_cards_to_users}if(aV===0&&!(T.is_empty(aU.show_cards_to_users))&&typeof(aU.show_cards_to_users.value)==="number"){aV=aU.show_cards_to_users.value}var aQ="";if(typeof(aP.editor_role)==="string"){aQ=aP.editor_role}if(aQ===""&&!(T.is_empty(aU.editor_role))&&typeof(aU.editor_role.value)==="string"){aQ=aU.editor_role.value}switch(aV){case 1:if(aT){return false}var aW=o.user_id;if(typeof(aW)==="string"&&aW!==""){aW=u(aW);if(at(aP).indexOf(aW)!==-1){return false}}case 2:var aS=aQ!==""&&ah().indexOf(aQ)===-1;if(aS&&i){H.log("hidden since your roles do not match the designated editor role. editor role key: "+aQ+", the proto key is "+aR._id,LOG_LEVEL.message)}return aS;case 4:if(aT){return false}if(i){H.log("this Card is only visible to Administrators",LOG_LEVEL.message)}return true}return false}function aw(i){if(i.hidden===true){return true}if(i.show_to_users===4&&!(g())){return true}}function aB(aP){var i="";if(Array.isArray(aP)){i=aP.join()}else{i=String(aP)}return i}function m(aQ,a5,a1,a6){var aT=["Text","Number"];if(a5){aT.push("MultilanguageText");aT.push("Relation")}var a3=[];if(!(T.is_empty(aQ.design_elements))){var aV=G(aQ);var aX=0;var aS=null;for(var a2=0;a2<aQ.design_elements.length;a2++){var a4=z(aQ.design_elements[a2]);aS=T.get_property(a4,"display_priority");if(typeof(aS)!=="number"||a4.deleted===true){aS=0}if(aS>aX){aX=aS}}var aP=-1;while(a3.length<a1&&aQ.design_elements.length&&aQ.design_elements.length>aP+1){aP++;var aW=aQ.design_elements[aP];if(T.is_empty(aW)){H.log("invalid design element found in related document "+aQ._id+" at index "+String(aP),LOG_LEVEL.warning);continue}var a0=z(aW);if(a0.deleted===true){continue}if(a0.cardinality_setting===2||a0.multiple_values_setting===1||Array.isArray(a0.value)){continue}aS=T.get_property(a0,"display_priority");if(typeof(aS)!=="number"){aS=0}if(aS<aX){continue}if(T.get_property(a0,"user_enabled_setting")===2){continue}identifier=I(aW);if(typeof(identifier)!=="string"||identifier===""){continue}var aR=T.get_property(a0,"element_type");if(typeof(aR)!=="string"||aT.indexOf(aR)===-1){continue}var aZ=T.get_property(aW,"value");if(T.is_empty(aZ)){continue}var aY="";if(aR==="MultilanguageText"){aY=j(aZ,"",a6)}else{if(aR==="Relation"){var aU=B(aZ,false);if(T.is_empty(aU)){continue}if(aU.deleted===true){continue}aY=ao(aU,false,1,"Parent: ",undefined,a6)}else{aY=aB(aZ)}}if(aY===""){continue}a3.push(aY)}}return a3}function ad(i,aQ){var aP=G(i);var aR="";if(aP.shortname!==undefined){aR=y(aP.shortname,aQ)}if(aR===""&&aP.name!==undefined){aR=y(aP.name,aQ)}if(aR===""&&aP.plural_name!==undefined){aR=y(aP.name,aQ)}if(aR===""&&aP.label!==undefined){aR=y(aP.label,aQ)}return aR}function ao(aR,aS,aQ,aX,i,aP){function aT(){var aZ=T.get_property(aR.denormalized,aR._id);
if(typeof(aZ)==="object"&&aZ!==null&&typeof(aZ.shortname)==="object"&&aZ.shortname!==null){aU=aF(aZ.shortname,function(a0){return a0},i)[0]}return aU}if(T.is_empty(aR)){return""}if(aR.definition_type==="ApplicationProperties"){return j(ML_KEYS.application_properties_key,"application properties",i)}if(aR.definition_type==="ImportExportCard"){return j(ML_KEYS.import_export_title_key,"import export",i)}var aU="";if(aP!==true){aU=aT();if(aU!==""){return aU}}var aY=aD(aR);if(T.is_function(aY.get_shortname)){aU=aY.get_shortname(a(aR))}if(aU!==""){return aU}if(aS===undefined){aS=true}if(aQ===undefined){aQ=3}if(aX===undefined){aX="Card: "}aU=ad(aR,i);if(aU===""){var aW=m(aR,aS,aQ,i);aU=aW.join()}if(aU===""){aU=aT();if(aU!==""){return aU}}if(aU===""){var aV=null;if(aR.proto_key!==undefined){aV=B(aR.proto_key)}if(!(T.is_empty(aV))){aU=ad(aV,i)}}if(typeof(aR.definition_type)==="string"&&aR.definition_type!==""){if(aU===""){aU=aR.definition_type+":"+aR._id}else{aU=aR.definition_type+":"+aU}}if(aU===""){aU=aX+aR._id}return aU}function N(i,aP){if(aP!==true){return i}return j(ML_KEYS.before_first_save_card_save_prefix)+" "+i}function am(aP,aS){if(aS===undefined){aS=false}var aR="";var i=aD(aP);if(T.is_function(i.get_title)){aR=i.get_title(a(aP),aS)}if(aR!==""){return aR}var aQ=T.get_property(aP,"title_multilanguage_key");if(typeof(aQ)==="string"&&aQ!==""){return N(j(aQ,"[MultiLanguage Card "+aQ+" for title not found]"),aS)}return N(ao(aP),aS)}function aG(aT,aQ,aS,aP){var aU={};if(!(Array.isArray(aT))){return aU}for(var aR=0;aR<aT.length;aR++){if(T.is_empty(aT[aR])||aT[aR]._id===undefined){continue}aU[aT[aR]._id]=ao(aT[aR])}return aU}function x(aP,i){if(typeof(i)!=="boolean"){i=true}if(typeof(aP)!=="object"||aP===null||Array.isArray(aP)){H.log("cannot get type of invalid card: "+JSON.stringify(aP),LOG_LEVEL.error);return null}if(i&&typeof(aP._id)==="string"&&aP._id in aL){return x(aL[aP._id],false)}if(!("definition_type" in aP)||aP.definition_type==="DynamicCard"){if(!("proto_key" in aP)){H.log("card with id neither contains a definition type nor a proto key - invalid type; card: "+JSON.stringify(aP));return null}return"DynamicCard"}card_type=aP.definition_type+"Definition";if(!(card_type in X)){return"DynamicCard"}return card_type}function au(aS,aQ){var aX=x(aS);if(aX==="ProtoDefinition"){var aP=G(aS);var aW=null;if(!(T.is_empty(aP.card_design_elements))){aW=aP.card_design_elements.value}var aR=false;var aU=false;if(Array.isArray(aW)){for(var aV=0;aV<aW.length;aV++){var aT=B(aW[aV],false);if(typeof(aT)!=="object"||aT===null){continue}var aY=x(aT);if(aY==="TableViewDefinition"){aU=true;continue}if(aY==="ButtonDefinition"){continue}aR=true}}if(aR===true){return j(ML_KEYS.data_proto,"Data Proto",aQ)}if(aU===true){return j(ML_KEYS.tableview_proto,"Overview Proto",aQ)}return j(ML_KEYS.utility_proto,"Utility Proto",aQ)}return aX}function R(aR){var aQ=[];if(!(Array.isArray(aR))){H.log("cannot heal cards: not in array form",LOG_LEVEL.error)}for(var aP=0;aP<aR.length;aP++){aQ.push(aK(aR[aP]))}return aQ}function aK(aS,a1,aP){function aQ(a3,a7,a6){if(Array.isArray(a3.design_elements)&&Array.isArray(a7)){var a5=G(a7);for(var a4=0;a4<a3.design_elements.length;a4++){if(a3.definition_type==="Log"&&a3.design_elements[a4].value_type==="unicode"&&typeof(a3.design_elements[a4].value)==="string"&&a3.design_elements[a4].value.trim()===""||a3.definition_type!=="Log"&&typeof(a3.design_elements[a4][a6])==="string"&&!(a3.design_elements[a4][a6] in a5)){a3.design_elements[a4].hidden=true}}}}if(T.is_empty(aS)||typeof(aS)!=="object"){return{}}if(typeof(aS._id)!=="string"||aS._id===""){aS._id=T.get_uuid()}if(a1===undefined){a1={}}if(aP===undefined){aP=S}ac(aS);var aT=x(aS);if(aT===null){H.log("cannot heal card - type not recognized",LOG_LEVEL.error);return aS}if(aT==="DynamicCard"&&!("proto_key" in aS)&&aS._id in aL){aS.proto_key=aL[aS._id].proto_key}else{if(aT!=="DynamicCard"&&!("definition_type" in aS)&&aS._id in aL){aS.definition_type=aL[aS._id].definition_type}else{if(aT==="DynamicCard"&&"definition_type" in aS){aS.proto_key=aS.definition_type;
delete aS.definition_type;a1.value=true}}}if(typeof(aS.last_healed)==="string"&&aS.last_healed<STRUCTURE_VERSION){ai.migrate_card(a(aS));a1.value=true}var aY=aS;if(typeof(aY.temporary_data)==="object"&&aY.temporary_data!==null){delete aY.temporary_data}if(typeof(aY.denormalized)==="object"&&aY.denormalized!==null&&aY._id in aY.denormalized){delete aY.denormalized[aY._id]}if(aS._id in aL&&(typeof(aS.last_healed)!=="string"||aS.last_healed<STRUCTURE_VERSION)){var aU=aL[aS._id];if(aU.last_healed<STRUCTURE_VERSION){var a2=x(aU);if(a2===null){H.log("template card with unknown type: "+aU._id);a2=aT}aU=T.extend(X[a2],aU);aU.last_healed=STRUCTURE_VERSION;aL[aS._id]=aU}if(aU.readonly===true){aY=aU}else{aQ(aS,aU.design_elements,"name");aY=T.extend(aU,aS)}aY.last_healed=STRUCTURE_VERSION;a1.value=true}else{if(typeof(aS.last_healed)!=="string"||aS.last_healed<STRUCTURE_VERSION){aQ(aS,X[aT].design_elements,"name");aY=T.extend(X[aT],aS);aY.last_healed=STRUCTURE_VERSION;a1.value=true}}if(aT!=="DynamicCard"){return aY}var aX=aP[aS.proto_key];if(T.is_empty(aX)){H.log("cannot complete card healing for card "+aS._id+": proto not found or invalid ("+aS.proto_key+")");return aY}af(aY,aX);var aZ=G(aX);if(!("card_design_elements" in aZ)){return aY}var a0=aZ.card_design_elements.value;if(!(Array.isArray(a0))){H.log("invalid proto: card_design_elements is not a multivalue field: "+String(aZ.card_design_elements));return aY}var aR=[];for(var aW=0;aW<a0.length;aW++){var aV=B(a0[aW]);if(typeof(aV)!=="object"||aV===null||aV.deleted===true){continue}aR.push({definition_key:a0[aW],value:""})}aQ(aY,aR,"definition_key");aY.design_elements=T.extend(aR,aY.design_elements);return aY}function aH(aR){var aY={};switch(aR.definition_type){case"RelationField":case"UserRelationField":case"TableView":var aX=G(aR);var aQ=aR.parent_application_setting;if(typeof(aQ)!=="string"||aQ===""){aQ=aR.application_setting}if(typeof(aQ)!=="string"||aQ===""){aQ=T.get_property(aX.parent_application_setting,"value")}if(typeof(aQ)!=="string"||aQ===""){aQ=T.get_property(aX.application_setting,"value")}if(typeof(aQ)==="string"&&aQ!==""){aY.parent_application_id=aQ}}var aU=ap("&&multilanguageProto");var aW=G(aU);var aS=aW.card_design_elements.value;var aT={};var aZ={};for(var aV=0;aV<aS.length;aV++){aT[aS[aV]]=ao(aR,undefined,undefined,undefined,aS[aV],true);var aP=au(aR,aS[aV]);if(typeof(aP)!=="string"||aP===""){H.log("could not determine type in language "+aS[aV]+" for card "+JSON.stringify(aR));aZ[aS[aV]]="n/a"}else{aZ[aS[aV]]=au(aR,aS[aV])}}aY.shortname=aT;aY.displayable_type=aZ;return aY}function ay(aQ,aX){function aU(a1,aZ,i){var a0=null;if(typeof(i)==="string"&&i!==""){a0={parent_application_id:i}}else{var aY=B(a1,false);if(T.is_empty(aY)){return}a0=aH(aY)}if(T.is_empty(a0)){H.log("no denormalized data could be extracted from card "+a1+" in order to update denormalized data for "+aZ._id);return}if(T.is_empty(aZ.denormalized)){aZ.denormalized={}}aZ.denormalized[a1]=a0}if(typeof(aQ)!=="object"||aQ===null){H.log("card has invalid type, cannot update denormalized data: "+String(aQ),LOG_LEVEL.error);return}if(typeof(aX)!=="boolean"){aX=false}var aS=aH(aQ);if(T.is_empty(aQ.denormalized)){aQ.denormalized={}}aQ.denormalized[aQ._id]=aS;if(aX===true||x(aQ)!=="DynamicCard"){return}for(var aV=0;aV<aQ.design_elements.length;aV++){var aW=aQ.design_elements[aV];if(typeof(aW.definition_key)!=="string"||aW.definition_key===""){continue}var aT=B(aW.definition_key);if(typeof(aT)!=="object"||aT===null||aT.deleted===true){continue}if(["RelationField","UserRelationField"].indexOf(aT.definition_type)===-1){continue}aU(aW.definition_key,aQ);relation_field_denormalized_data=T.get_property(aQ.denormalized,aW.definition_key);var aP=null;if(!(T.is_empty(relation_field_denormalized_data))&&typeof(relation_field_denormalized_data.parent_application_id)==="string"&&relation_field_denormalized_data.parent_application_id!==""&&relation_field_denormalized_data.parent_application_id!==A.application_key){aP=relation_field_denormalized_data.parent_application_id
}if(typeof(aW.value)==="string"&&aW.value!==""){aU(aW.value,aQ,aP)}else{if(Array.isArray(aW.value)){for(var aR=0;aR<aW.value.length;aR++){aU(aW.value[aR],aQ,aP)}}else{if(aW.value!==""){H.log("design element value neither string nor array - cannot denormalize : "+JSON.stringify(aW.value))}}}}}function aC(aR,aU){if(typeof(aR)!=="object"||aR===null){H.log("card is of invalid type, cannot update relating cards: "+String(aR),LOG_LEVEL.error);return null}if(!(Array.isArray(aU))){H.log("relating cards are not of array type, cannot update denormalization",LOG_LEVEL.error);return null}if(typeof(aR.definition_type)==="string"&&aR.definition_type.indexOf("Field")!==-1){var aT=null;for(var aS=0;aS<aU.length;aS++){if(aU[aS].definition_type==="Proto"){aT=aU[aS];break}}if(aT===null){H.log("cannot update denormalization of proto - proto not found as a relating card when saving field "+aR._id)}var aQ=G(aT);var aW=[];if(Array.isArray(aQ.card_design_elements.value)){aW=aQ.card_design_elements.value}if(aW.indexOf(aR._id)===-1){aW.push(aR._id)}}var aV=aH(aR);var aP=[];if(!(T.is_empty(aV))){for(var aS=0;aS<aU.length;aS++){if(T.is_empty(aU[aS].denormalized)){aU[aS].denormalized={}}aU[aS].denormalized[aR._id]=aV;ay(aU[aS],true);F(aU[aS]);aP.push(aU[aS])}}return aP}function ap(i){var aP=B(i);if(aP===null){H.log("proto is missing in this application: "+i,LOG_LEVEL.error);return null}if(aP.definition_type!=="Proto"){H.log("invalid definition type in proto: "+aP.definition_type,LOG_LEVEL.error);return null}return aP}function r(aQ){var aP="";var i=Date.parse(aQ);if(isNaN(i)){H.log("The following value could not be interpreted as a date: "+aQ,LOG_LEVEL.message);return aP}var aR=new Date(i);return aR.toISOString()}function aI(aP,aS){if(typeof(aP)!=="object"||aP===null){H.log("card has invalid type, cannot apply posted form: "+String(aP),LOG_LEVEL.error);return null}if(typeof(aS)!=="object"||aS===null){H.log("posted form has invalid type, cannot apply to card: "+String(aS),LOG_LEVEL.error);return aP}var aX=T.clone(aP);if(!(Array.isArray(aP.design_elements))){return aX}for(var aQ=0;aQ<aX.design_elements.length;aQ++){var aR=aX.design_elements[aQ];var aT=I(aR);var aU=z(aR);if(aU.creates_value===false){continue}if((aU.multiple_values_setting===1||aU.cardinality_setting===2)&&aU.value_type!=="key"){H.log(aT+": multiple values setting is only supported with value_type 'key'",LOG_LEVEL.error);continue}var aW=null;var aV=aS[aT];if(aV===undefined&&(aU.multiple_values_setting===1||aU.cardinality_setting===2)){continue}if(aV===undefined){continue}if(aU.multiple_values_setting===1||aU.cardinality_setting===2){if(Array.isArray(aV)){aW=aV}else{if(typeof(aV)==="string"&&aV!==""){aW=aV.split(",")}else{if(aV===""){aW=[]}else{H.log(aT+": unrecognised value format for multivalue key",LOG_LEVEL.error)}}}}else{switch(aU.value_type){case"unicode":case"key":aW=String(aV);break;case"date":aW="";if(typeof(aV)==="string"&&aV!==""){aW=r(aV)}break;case"number":if(aV===""||aV===null){aW=null}else{if(isNaN(Number(aV))){aW=String(aV)}else{aW=Number(aV)}}break;case"boolean":if(aV==="Yes"||aV===true){aW=true}else{aW=false}break;default:aW=String(aV)}}aR.value=aW}return aX}function k(i){return/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/i.test(i)}function t(i){var aP=[];if(!(T.is_empty(i))&&!(T.is_empty(i.modification_log))){aP=i.modification_log}return aP}function b(aR,aP){var aS="";var i=null;var aT=t(aR);var aQ=aT.length;if(aQ>0){i=aT[aQ-1];aS=T.get_property(i,aP);if(T.is_empty(aS)){aS=""}}return aS}function ak(aQ,aP){var aR="";var i=null;var aS=t(aQ);if(aS.length>0){i=aS[0];aR=T.get_property(i,aP);if(T.is_empty(aR)){aR=""}}return aR}function W(aS,aU){var aP=[];for(var aQ=0;aQ<aS.length;aQ++){var aT=false;for(var aR=0;aR<aU.length;aR++){if(aS[aQ]._id===aU[aR]._id){aT=true;break}}if(aT===false){aP.push(aS[aQ])}}return aP}function Y(aS,ba,bo,aU){function bh(bs){var br={};for(var bt=0;bt<bs.length;bt++){ay(bs[bt],true);F(bs[bt]);if(bs[bt].readonly===true&&"user_id" in o&&o.user_id!=="system_and_support"){continue
}br[bs[bt]._id]=bs[bt]}return br}aS=a(aS);if(!("_id" in aS)){return bh(ag)}var aQ=aI(aS,ba);var aZ=aD(aQ);if(T.is_function(aZ.on_save)){aZ.on_save(a(aQ),bo,aU)}var a3=[];var a4=G(aS);var bd=G(aQ);if(!(Array.isArray(aS.design_elements))){ay(aQ);a3.push(aQ);return bh(a3.concat(W(ag,a3)))}for(var aV in bd){var a8=bd[aV];var i=z(a8);var aW=T.get_property(a4[aV],"value");var a9=T.get_property(bd[aV],"value");switch(i.element_type){case"MultilanguageText":if((typeof(aW)!=="string"||aW===""||!(k(aW)||aW.indexOf("&&mlkey")!==-1)||aW!==a9)&&a9!==""&&!(k(a9))){var aR=h();var a7=ap("&&multilanguageProto");if(a7===null){H.log("could not get multilanguage proto card for this application - aborting multilanguage card save.",LOG_LEVEL.error);continue}var a5=G(a7);if(!("card_design_elements" in a5)||a5.card_design_elements.value.indexOf(aR)===-1){a7=aK(a7);a5=G(a7);a5.card_design_elements.value.push(aR);S["&&multilanguageProto"]=a7;a3.push(a7);language_field_definition_card=aK({_id:aR,definition_type:"TextField",design_elements:[{name:"grid_size_setting",value:1},{name:"number_of_lines_setting",value:1}]});S[aR]=language_field_definition_card;a3.push(language_field_definition_card)}var bj=T.get_uuid();var bp=aK({_id:bj,proto_key:"&&multilanguageProto"});var a2=G(bp);a2[aR].value=a9;S[bj]=bp;a3.push(bp);bd[aV].value=bj}break}}if(aQ.definition_type==="RelationField"){var bi=G(aQ);var bq=0;if(!(T.is_empty(bi.presentation_setting))){bq=bi.presentation_setting.value}switch(bq){case 1:bi.cardinality_setting.value=2;bi.allow_new_cards.value=false;break;case 2:bi.cardinality_setting.value=2;bi.allow_new_cards.value=true;break;default:bi.cardinality_setting.value=1;bi.allow_new_cards.value=false}}else{if(aQ.definition_type==="ApplicationProperties"){var be=aQ.get_value("languages");var aX=B("&&multilanguageProto");if(!(T.is_empty(aX))){var aP=aX.get_value("card_design_elements");var bf=false;if(JSON.stringify(be)!==JSON.stringify(aP)){bf=true}for(var bn=0;bn<be.length;bn++){if(aP.indexOf(be[bn])===-1){var a6={_id:be[bn],design_elements:[{name:"grid_size_setting",value:1},{name:"number_of_lines_setting",value:1}]};a6.__proto__=X.TextFieldDefinition;S[be[bn]]=a6;a3.push(a6);bf=true}}if(bf){if(!(aX.set_design_element_value("card_design_elements",be,false))){H.log("could not add a language - element on multilanguage proto card not found",LOG_LEVEL.error)}else{S["&&multilanguageProto"]=aX;a3.push(aX)}}}}else{if(aQ.definition_type==="Proto"&&bo===true){var bc=bd.cards_based_on_this;if(typeof(bc)==="object"&&bc!==null){bc.application_setting=A.application_key;bc.entity_proto_setting=aQ._id}else{H.log("cards tableview not found in proto")}var bm=T.get_property(bd.plural_name,"value");if(typeof(bm)!=="string"||bm===""){bm=T.get_property(bd.name,"value")}if(typeof(bm)!=="string"||bm===""){bm=ML_KEYS.new_tableview_key}var aT=aK({definition_type:"TableView",design_elements:[{name:"application_setting",value:A.application_key},{name:"entity_proto_setting",value:aQ._id},{name:"label",value:bm}]});S[aT._id]=aT;a3.push(aT);var bb=T.get_uuid();var a1=aK({_id:bb,definition_type:"Proto",design_elements:[{name:"name",value:bm},{name:"card_design_elements",value:[aT._id]}]});var a0=G(a1);a0.cards_based_on_this.application_setting=A.application_key;a0.cards_based_on_this.entity_proto_setting=a1._id;S[a1._id]=a1;a3.push(a1);var bg=bd.automatically_created_tableview_proto;bg.hidden=false;bg.value=bb;var bk=aK({proto_key:bb,automatically_created_for_proto:aQ._id});S[bk._id]=bk;a3.push(bk);var bl=B("&&userMenuDefinition",false);if(T.is_empty(bl)){bl=aK({_id:"&&userMenuDefinition",definition_type:"Menu"});S[bl._id]=bl;a3.push(bl);application_properties=B("&&applicationProperties");if(T.is_empty(application_properties)){H.log("no application properties found in related cards, cannot properly initialize Proto",LOG_LEVEL.error)}else{application_properties_index=G(application_properties);menus=T.get_property(application_properties_index.menu_definitions,"value");if(!Array.isArray(menus)){H.log("invalid menus list in application properties, cannot properly initialize Proto",LOG_LEVEL.error)
}else{menus.push(bl._id);a3.push(application_properties)}}}user_menu_definition_index=G(bl);entries=T.get_property(user_menu_definition_index.menu_entries,"value");if(!Array.isArray(entries)){H.log("invalid menu entry list in user menu definition, cannot properly initialize Proto",LOG_LEVEL.error)}else{entries.push(bk._id);a3.push(bl)}}}}ay(aQ);a3.unshift(aQ);var aY=bh(a3.concat(W(ag,a3)));return aY}function q(aR,aS){for(var aQ=0;aQ<aS.length;aQ++){var aP=I(aS[aQ]);if(aS[aQ]!==aR[aP]){return false}if(aS[aQ].value!==aR[aP].value){return false}}return true}function G(aR){if(typeof(aR)!=="object"||aR===null){return{}}var aU=null;var aQ=null;var aT=null;if(!(Array.isArray(aR))){aQ=aR;aT=T.get_property(aR.temporary_data,"element_index");aU=aQ.design_elements;if(typeof(aT)==="object"&&aT!==null){return aT}}else{aU=aR}if(!(Array.isArray(aU))){return{}}aT={};for(var aS=0;aS<aU.length;aS++){if(typeof(aU[aS])!=="object"||aU[aS]===null||(Array.isArray(aU[aS]))){continue}var aP=I(aU[aS]);if(aP===null){continue}aT[aP]=aU[aS]}if(aQ!==null&&"temporary_data" in aQ){aQ.temporary_data.element_index=aT}else{if(aQ!==null){aQ.temporary_data={element_index:aT}}}return aT}function I(i){if(typeof(i)!=="object"||i===null){H.log("cannot get identifier - design element is not an object",LOG_LEVEL.error);return null}if("definition_key" in i){return i.definition_key}if("name" in i){return i.name}H.log("cannot get identifier - no 'name' or 'definition_key' property in design element",LOG_LEVEL.error);return null}function v(i){if(typeof(i)!=="object"||i===null){H.log("cannot get identifier - design element properties is not an object",LOG_LEVEL.error);return null}if("definition_key" in i){return i.definition_key}if("name" in i){return i.name}H.log("cannot get identifier - no 'name' or 'definition_key' property in properties: "+JSON.stringify(i),LOG_LEVEL.error);return null}function y(i,aR){var aP=z(i);if(aP.element_type=="MultilanguageText"){return j(i.value,"",aR)}if(aP.value_type=="key"){var aQ=B(i.value);if(T.is_empty(aQ)){return ao(aQ)}else{return""}}return i.value}function V(aR){var aP=z(aR);var i=T.get_property(aP,"label");if(typeof(i)!=="string"||i===""){i=T.get_property(aP,"label_multilanguage_key")}var aQ=j(i,"");if(aQ===""){aQ=I(aR)}return aQ}function z(aP){if(typeof(aP)!=="object"||aP===null||Array.isArray(aP)){H.log("cannot retrieve properties - invalid design element: "+String(aP),LOG_LEVEL.warning);return{}}var aT=null;var aS=null;if("definition_key" in aP){aS=aP.definition_key;aT=B(aS,false)}var i={};if(!(T.is_empty(aT))){if(aT.deleted===true){i.deleted=true;return i}for(var aQ in aT){if(aQ==="_id"||aQ==="design_elements"||aQ==="modification_log"||aQ==="denormalized"){continue}i[aQ]=aT[aQ]}if(Array.isArray(aT.design_elements)){aT.design_element_index=G(aT);for(var aR in aT.design_element_index){i[aR]=aT.design_element_index[aR].value}}}for(var aU in aP){i[aU]=aP[aU]}return i}function f(i){if(typeof(i)!=="object"||i===null){return[]}return Object.keys(i)}function e(aP,i){var aQ={key:aP,proto_key:i};return aK(aQ)}function aq(aP,i){var aQ={key:aP,definition_type:i};return aK(aQ)}function B(aQ,aR,i){if(aR===undefined){aR=true}var aP=S;if(typeof(i)==="object"&&i!==null){aP=i}if(typeof(aQ)!=="string"||aQ===""||aQ==="$$$"){if(aR){H.log("cannot resolve card for invalid key: "+String(aQ))}return null}else{if(aQ in aP){return a(aP[aQ])}else{if(aQ.indexOf("Definition")!==-1&&X[aQ]!==undefined){return a(T.clone(X[aQ]))}else{if("org.couchdb.user:"+aQ in aP){return a(aP["org.couchdb.user:"+aQ])}else{if(aR){H.log("cannot resolve key from cards given in context: "+String(aQ))}}}}}return null}function h(){if(J!==null){return J}var aR=B("&&multilanguageProto");if(typeof(aR)!=="object"||aR===null){H.log("ML Proto not found, cannot determine active language");J="en";return J}var aU=aR.get_value("card_design_elements");if(!(Array.isArray(aU))){H.log("Invalid ML Proto, cannot determine active language");J="en";return J}if(aU.length===0){J="en";return J}var aT=T.get_property(o,"languages");
if(!(Array.isArray(aT))){J=aU[0];return J}for(var aS=0;aS<aT.length;aS++){if(aU.indexOf(aT[aS])!==-1){J=aT[aS];return J}var aP=aT[aS].split("_");if(aP.length<2){continue}for(var aQ=aP.length-1;aQ>=1;aQ--){var i=aP.slice(0,aQ).join("_");if(aU.indexOf(i)!==-1){J=i;return J}}}J=aU[0];return J}function aF(aV,aX,aP){var aS=null;if(typeof(aP)==="string"&&aP!==""){aS=[aP]}else{aS=T.get_property(o,"languages")}var a2="";if(Array.isArray(aS)){for(var aY=0;aY<aS.length;aY++){if(aS[aY] in aV){a2=aX(aV[aS[aY]])}if(typeof(a2)==="string"&&a2!==""){return[a2,aS[aY]]}var aQ=aS[aY].split("_");if(aQ.length<2){continue}for(var aT=aQ.length-1;aT>=1;aT--){var aR=aQ.slice(0,aT).join("_");if(aR in aV){a2=aX(aV[aR])}if(typeof(a2)==="string"&&a2!==""){return[a2,aR]}}}}var aZ=B("&&multilanguageProto");if(typeof(aZ)==="object"&&aZ!==null){var a1=aZ.get_value("card_design_elements");if(Array.isArray(a1)){for(var aU=0;aU<a1.length;aU++){var aW=a1[aU];if(aW in aV){a2=aX(aV[aW])}if(typeof(a2)==="string"&&a2!==""){return[a2,aW]}}}}if("en" in aV){a2=aX(aV.en)}if(typeof(a2)==="string"&&a2!==""){return[a2,"en"]}if("en_US" in aV){a2=aX(aV.en_US)}if(typeof(a2)==="string"&&a2!==""){return[a2,"en_US"]}var a0=Object.keys(aV);if(a0.length>0){a2=aX(aV[a0[0]])}return[a2,a0[0]]}function w(aT,aR){if(typeof(aT)!=="boolean"){aT=false}if(!(Array.isArray(aR))){aR=[]}var aP=Object.keys(LANGUAGE_BY_LOCALE);if(!aT){return aP}var i=[];for(var aQ=0;aQ<aP.length;aQ++){var aS=aP[aQ].split("_");if(aS.length>1&&aR.indexOf(aS[0])===-1){continue}i.push(aP[aQ])}return i}function al(aP){var i=B(aP,false);if(i!==null){i.design_element_index=G(i);return aF(i.design_element_index,function(aQ){return aQ.value})}return["",null]}function j(aR,aS,aQ){var i="";var aP=B(aR,false);if(aP!==null){aP.design_element_index=G(aP);i=aF(aP.design_element_index,function(aT){return aT.value},aQ)[0]}if(i!==""){return i}if(aS!==undefined){return aS}else{H.log("cannot get multilanguage text for key from cards given in context: "+String(aR));return"[Missing Multilanguage Text]"}}function aD(aP){if(T.is_empty(aP)||aP.definition_type==="Proto"){return{}}var i=aP.proto_key;var aQ=null;if(typeof(i)==="string"){aQ=B(i)}if(typeof(script_libraries_by_applicable_key)!=="object"){return{}}if(!(T.is_empty(script_libraries_by_applicable_key[aP._id]))){return script_libraries_by_applicable_key[aP._id]}if(!(T.is_empty(aQ))&&!(T.is_empty(script_libraries_by_applicable_key[aQ._id]))){return script_libraries_by_applicable_key[aQ._id]}return{}}function C(aQ){if(Array.isArray(aQ.value)){return aQ.value}if(aQ.value===""){return[]}var aP=v(aQ);var i="design element "+aP+": expected value is an array of "+aQ.value_type+", but is of simple type "+typeof(aQ.value);switch(aQ.value_type){case"boolean":H.log(i);if(typeof(aQ.value)==="boolean"){return[aQ.value]}break;case"number":H.log(i);if(typeof(aQ.value)==="number"){return[aQ.value]}if(typeof(aQ.value)==="boolean"){return[Number(aQ.value)]}break;case"unicode":case"date":H.log(i);if(typeof(aQ.value)==="string"&&aQ.value!==""){return[aQ.value]}if(typeof(aQ.value)==="number"){return[String(aQ.value)]}break;case"key":if(typeof(aQ.value)==="string"&&aQ.value!==""){return aQ.value.split(",")}break}return[]}function ae(aQ){var aP=v(aQ);var i="design element "+aP+": expected value is of type "+aQ.value_type+", but is of type "+typeof(aQ.value);switch(aQ.value_type){case"boolean":if(typeof(aQ.value)==="boolean"){return aQ.value}H.log(i);return false;case"number":if(aQ.value===null){return""}if(typeof(aQ.value)==="number"||typeof(aQ.value)==="string"){return aQ.value}H.log(i);if(typeof(aQ.value)==="boolean"){return Number(aQ.value)}break;case"unicode":if(typeof(aQ.value)==="string"){return aQ.value}H.log(i);if(typeof(aQ.value)==="number"){return String(aQ.value)}break;case"key":case"date":if(typeof(aQ.value)==="string"){return aQ.value}if(Array.isArray(aQ.value)){return aQ.value[0]}H.log(i);break;case"attachment":if(typeof(aQ.value)==="object"&&aQ.value!==null&&!(Array.isArray(aQ.value))){return aQ.value
}return{}}return""}function U(i){if(i.multiple_values_setting===1||i.cardinality_setting===2){return C(i)}return ae(i)}function P(i){var aP=T.get_property(i,"definition_type");if(typeof(aP)==="string"&&aP!==""){return aP}if(typeof(i.automatically_created_for_proto)==="string"&&i.automatically_created_for_proto!==""){return i.automatically_created_for_proto}aP=T.get_property(i,"proto_key");if(typeof(aP)==="string"&&aP!==""){return aP}return null}function av(aZ,aX,aU,a4){var a8={};if(typeof(aZ)!=="object"||aZ===null){aZ={}}var a2={};for(var a6=0;a6<aX.length;a6++){aX[a6]=a(aX[a6])}for(var a5=0;a5<aX.length;a5++){var aP=aX[a5]._id;if(typeof(aP)!=="string"||aP===""){H.log("no _id in healed Card. i: "+a5+", length: "+aX.length+", healed Card: "+JSON.stringify(aX[a5]));continue}var aT=Y(aX[a5],posted_form,a4,validation_errors);a8=T.merge(a8,aT);var a1=B(aP,false,a8);if(typeof(a1)!=="object"||a1===null){continue}a2=validator.get_validation_errors(a1,validation_errors);if(!(T.is_empty(a2))){break}for(var a3=0;a3<aU.length;a3++){var a7=aU[a3]._id;var aR=B(a7,false,a8);if(typeof(aR)==="object"&&aR!==null){aU[a3]=aR}}var a0=aC(a1,aU);if(Array.isArray(a0)){for(var a3=0;a3<a0.length;a3++){a8[a0[a3]._id]=a0[a3]}}}var aV=null;var aW=[];if(T.is_empty(a2)){aV=[];var aS=null;for(var aY in a8){if(aY!==aX[0]._id&&aY!=="org.couchdb.user:"+aX[0]._id){aV.push(a8[aY]);aW.push(aY)}else{aS=aY}}if(aS!==null){aV.unshift(a8[aS]);aW.unshift(aS)}}else{for(var aQ in a2){aZ[aQ]=a2[aQ]}}return aV}var L={cleanup_card_for_storage:F,template_cards_by_key:aL,related_cards_by_key:S,get_template_card_keys:aO,get_cards_needing_update:an,get_family_of_user_creatables:az,get_design_element_properties_by_name:aE,get_relation_field_ids_associated_to_proto_by_proto_key:aj,get_value_from_last_modification_log_entry:b,get_value_from_first_modification_log_entry:ak,get_short_representation:ao,get_short_representations_by_key:aG,get_title:am,get_card_type:x,get_displayable_card_type:au,get_healed_cards:R,get_healed_card:aK,get_relating_cards_with_updated_denormalized_data:aC,get_user_role_keys:ah,get_attachment_names:f,is_current_user_admin:g,are_new_cards_creatable:aJ,is_card_editable:s,is_uuid:k,is_card_hidden:l,is_design_element_hidden:aw,get_card_with_posted_form_applied_by_value_type:aI,get_updated_and_new_cards_by_id:Y,get_element_index:G,get_design_element_identifier:I,get_design_element_identifier_from_properties:v,get_design_element_properties:z,get_design_element_content:y,get_design_element_label:V,create_dynamic_card:e,create_static_card:aq,resolve_key:B,get_active_language:h,get_available_locales:w,get_multilanguage_string_and_language_from_object_indexed_by_language:aF,get_multilanguage_string_and_language:al,get_multilanguage_string:j,get_script_library:aD,get_responded_value_from_design_element_properties:U,get_definition:P,get_updated_cards_and_validation_errors:av,monkey_patch_card:a};var aM={};var K=Object.keys(L);for(var Q=0;Q<K.length;Q++){var ab=L[K[Q]];if(typeof(D)==="object"&&D!==null){aM[K[Q]]=D.profile(ab)}else{aM[K[Q]]=ab}}return aM};
function mod_migrations(h,f){var c=mod_helper();var d=mod_design_element_structure();var g=h;var k=f;var i={"2013-12-18T16:39:47":function(l){j(l,"number_of_lines_setting")},"2013-12-19T13:49:57":function(l){j(l,"grid_size_setting")},"2014-01-24T20:45:49":function(l){j(l,"allow_new_cards")},"2014-01-25T09:32:33":function(l){j(l,"user_enabled_setting")},"2014-02-11T09:47:26":function(l){j(l,"parent_application_setting")},"2014-02-25T16:53:25":function(l){if("readonly" in l){delete l.readonly}},"2014-03-05T10:52:20":function(m){if(m.definition_type!=="User"){return}var l=m.get_value("assigned_roles",[]);if(m.get_value("is_enviroment_manager_setting")===true&&l.indexOf("&&systemRole")===-1){l.push("&&systemRole");if(!(m.set_design_element_value("assigned_roles",l,false))){k.log("could not add a new role - element on user Card not found",LOG_LEVEL.error)}m.roles=c.clone(l)}},"2014-03-07T09:36:12":function(l){if(g.application_key==="roles"&&l._id==="&&applicationProperties"){delete l.design_elements}},"2014-04-28T22:00:00":function(m){if(m.definition_type==="Proto"&&m.hidden===true){delete m.hidden}if(m.definition_type==="TableView"){var l=m.get_design_element("application_setting");if(l!==null&&(typeof(l.value)!=="string"||l.value==="")){l.value=g.application_key}}},"2014-04-29T13:08:33":function(m){j(m,"hidden");if(m.definition_type==="RelationField"){var l=0;var o=1;var p=m.get_design_element("cardinality_setting");if(!(c.is_empty(p))){o=p.value}var q=false;var n=m.get_design_element("allow_new_cards");if(!(c.is_empty(n))){q=n.value}if(o===2&&q===true){l=2}else{if(o===2){l=1}}m.set_design_element_value("presentation_setting",l)}},"2014-05-15T09:33:43":function(m){j(m,"couchdb_viewname");if(m.definition_type==="Proto"){var l=m.get_design_element("cards_based_on_this");if(l!==null){l.entity_proto_setting=m._id}}},"2014-05-15T22:12:43":function(l){j(l,"requirement_setting");j(l,"hidden")},"2014-09-02T05:02:45":function(l){j(l,"user_creatable")},"2015-02-11T15:05:19":function(l){if(l._id==="&&applicationProperties"){j(l,"grid_size_setting");l.design_elements=c.get_purged_list("languages",l.design_elements)}if(l._id==="&&multilanguageProto"){l.design_elements=c.get_purged_list("card_design_elements",l.design_elements)}if(l.proto_key==="&&multilanguageProto"){var m=l.get_value("en_US");if(typeof(m)!=="string"){m=""}l.design_elements=[{definition_key:"en",value:m}]}},"2015-02-27T03:07:55":function(m){if(m.proto_key==="&&multilanguageProto"){var l=m.set_element_value("en_US","",false);if(l===true){k.log("cleared 'en_US' in ML Definition with ID "+m._id+". (upgrade to Protogrid 1.0)",LOG_LEVEL.message)}}},"2016-02-17T05:31:30":function(l){j(l,"label_multilanguage_key");j(l,"help_text")},"2016-08-10T09:31:41":function(n){if(n.definition_type==="Proto"){var p=n.design_elements;var t=[];var s;var o;var q;var u=false;function l(){if(typeof(o)==="object"&&typeof(s)==="object"&&typeof(q)==="object"){t.push(o);t.push(s);t.push(q);u=true}}for(var r=0;r<p.length;r++){var m=p[r];if(typeof(m)==="object"&&m.name==="editor_role"){o=m;l()}else{if(typeof(m)==="object"&&m.name==="allow_editing_cards_to_users"){s=m;l()}else{if(typeof(m)==="object"&&m.name==="show_cards_to_users"){q=m;l()}else{t.push(m)}}}}if(u){n.design_elements=t}}},"2016-09-04T05:19:32":function(l){j(l,"couchdb_viewname")},"2017-04-14T03:06:11":function(l){if(l._id==="&&applicationProperties"){l.design_elements=c.get_purged_list("languages",l.design_elements)}if(l._id==="&&multilanguageProto"){l.design_elements=c.get_purged_list("card_design_elements",l.design_elements)}}};var e=Object.keys(i).sort();function j(n,l){if(!(Array.isArray(n.design_elements))){return}for(var o=0;o<n.design_elements.length;o++){var m=n.design_elements[o];if(l in m){delete m[l]}}return}function a(){return e[e.length-1]}function b(n){if(n.last_healed>=a()){return}for(var l=0;l<e.length;l++){if(n.last_healed>=e[l]){continue}var o=i[e[l]];o(n)}return}return{migrate_card:b}}function mod_card_tools(aC,d,au,ab,N,W){if(W===undefined){W=true
}var I=ab;var E=N;var U=mod_helper(E);var r=mod_design_element_structure();var Z=mod_card_structure();var q=aC;var B=d;var ak=mod_migrations(B,I);var ai=[];var P=aQ();var aO=c(P,au,W);var T=ac(au,ai);var az=p();var K=null;function G(i){if(i.get_value!==undefined&&i._id==="&&multilanguageProto"){}U.remove_property(i,"get_key");U.remove_property(i,"get_type");U.remove_property(i,"get_proto_key");U.remove_property(i,"get_design_element");U.remove_property(i,"get_value");U.remove_property(i,"set_design_element_value");U.remove_property(i,"get_design_element_properties");U.remove_property(i,"temporary_data");if("temporary_data" in i){I.log("temporary_data could not be removed from card "+i._id,LOG_LEVEL.error)}}function a(i){i.get_key=function(){return this._id};i.get_type=function(){return z(this)};i.get_proto_key=function(){return this.proto_key};i.get_design_element=function(aS){var aT=H(this);if(typeof(aT[aS])!=="object"||aT[aS]===null){return null}return aT[aS]};i.get_value=function(aU,aS){if(aS===undefined){aS=null}if(aU in this){return this[aU]}var aT=this.get_design_element(aU);if(aT===null){return aS}return aT.value};i.get_shortname=function(){return aq(this)};i.set_design_element_value=function(aU,aV,aS){if(typeof(aS)!=="boolean"){aS=true}var aT=this.get_design_element(aU);if(aT===null&&aS===true){this.design_elements.push({name:aU,value:aV});return true}else{if(aT===null){return false}}aT.value=aV;return true};i.set_element_value=function(aT,aU,aS){return this.set_design_element_value(aT,aU,aS)};i.get_design_element_properties=function(aT){var aS=this.get_design_element(aT);if(aS===null){return null}return A(aS)};return i}function p(){var aS=Object.keys(LANGUAGE_BY_LOCALE);var aU=[];for(var aT=0;aT<aS.length;aT++){if(aS[aT].indexOf("_")!==-1){continue}aU.push(aS[aT])}return aU}function aQ(){var i=null;if(B.application_key in system_templates_by_key){i=system_templates_by_key[B.application_key]}else{i=mod_minimal_template()}return i}function c(a3,a5,a0){function a4(a8,a7,a9,i,ba){foreign_template_card=a9[a8];i[a8]=foreign_template_card;foreign_template_card.persistent=false;if(a0||!(a8 in a5)){a5[a8]=foreign_template_card}ba[a8]=a7}var a6=U.merge(a3.readonly_cards_by_key,a3.editable_cards_by_key);var aV=null;var aX=Object.keys(a5);var aY={};var a2=null;for(var aW=0;aW<aX.length;aW++){if(aX[aW].indexOf("&&")==-1){continue}if(aX[aW] in a6){continue}if(aV===null){aV=Object.keys(system_templates_by_key)}for(var aU=0;aU<aV.length;aU++){a2=system_templates_by_key[aV[aU]];if(aX[aW] in a2.readonly_cards_by_key){a4(aX[aW],a2,a2.readonly_cards_by_key,a6,aY);break}if(aX[aW] in a2.editable_cards_by_key){a4(aX[aW],a2,a2.editable_cards_by_key,a6,aY);break}}}var aZ=Object.keys(aY);for(var aT=0;aT<aZ.length;aT++){a2=aY[aZ[aT]];var a1=a5[aZ[aT]];var aS=a1.proto_key;if(typeof(aS)==="string"&&aS!==""){if(aS in a2.readonly_cards_by_key){a4(aS,a2,a2.readonly_cards_by_key,a6,aY);continue}if(aS in a2.editable_cards_by_key){a4(aS,a2,a2.editable_cards_by_key,a6,aY);continue}}}return a6}function ae(aS){if(Array.isArray(aS.design_elements)){aS.design_elements=U.compact(aS.design_elements);for(var aT=0;aT<aS.design_elements.length;aT++){var aU=U.get_property(aS.design_elements[aT],"value");if(Array.isArray(aU)){aS.design_elements[aT].value=U.compact(aU)}}}else{aS.design_elements=[]}}function ac(a4,a3){if(a3===undefined){a3=[]}var a1=a4;var aS=Object.keys(aO);for(var aX=0;aX<aS.length;aX++){var a2=aS[aX];var aU=null;var aY=false;if(a2 in a1){aU=a1[a2];var a0=z(aO[a2]);if(a0==="DynamicCard"){aU.proto_key=aO[a2].proto_key}else{aU.definition_type=aO[a2].definition_type}}else{aU=aO[a2]}ae(aU);var aT=z(aU);if(aT===null){var aV=aO[a2];if(aV.definition_type!==undefined){aU.definition_type=aV.definition_type}if(aV.proto_key!==undefined){aU.proto_key=aV.proto_key}aT=z(aU);if(aT===null){I.log("template card with id "+a2+" is of unknown type. cannot fix.",LOG_LEVEL.error);continue}aY=true}if(typeof(aU.last_healed)==="string"&&aU.last_healed<STRUCTURE_VERSION){ak.migrate_card(a(aU));
aY=true}var aW=aU;if(typeof(aW.last_healed)!=="string"||aW.last_healed<STRUCTURE_VERSION){var aZ=U.extend(Z[aT],aO[a2]);if(aZ.readonly===true){aW=aZ}else{aW=U.extend(aZ,aU)}aW.last_healed=STRUCTURE_VERSION;aY=true}aO[a2]=aW;a1[a2]=aW;if(aY===true){a3.push(aW)}}return a1}function aR(){var i=aQ();return Object.keys(i.editable_cards_by_key).concat(Object.keys(i.readonly_cards_by_key))}function ap(){return ai}function F(aS,i){if(i.user_creatable===true){aS.push(i)}}function aB(aY){var a0=[];var aU=[];var a1=aY+"Definition";var aX=Z[a1];if(aX===undefined){I.log("no structure found with name "+a1,LOG_LEVEL.error);return aU}var aW=0;a0[aW]=[a1];F(aU,aX);var aT=Object.keys(Z);while(a0[aW].length>0){aW+=1;a0[aW]=[];for(var aV=0;aV<aT.length;aV++){var aZ=Z[aT[aV]];var aS=aZ.__proto__.definition_type;if(typeof(aS)==="string"&&a0[aW-1].indexOf(aS+"Definition")!==-1){a0[aW].push(aT[aV]);F(aU,aZ)}}}return aU}function aG(aT,i){if(U.is_empty(aT)){return{}}var aU=H(aT);var aS=aU[i];return A(aS)}function al(aV){var aY={};if(typeof(aV.proto_key)==="string"&&aV.proto_key!==""){aY[aV.proto_key]=["#"]}if(!(Array.isArray(aV.design_elements))){return aY}for(var aW=0;aW<aV.design_elements.length;aW++){var aU=aV.design_elements[aW];var aT=J(aU);if(aT===null){continue}var aS=A(aU);if(aS.deleted===true){continue}if(typeof(aS.parent_entity_proto_setting)==="string"&&aS.parent_entity_proto_setting!==""){var aX=aY[aS.parent_entity_proto_setting];if(!(Array.isArray(aX))){aY[aS.parent_entity_proto_setting]=[aT]}else{aX.push(aT)}}if(typeof(aS.parent_field_setting)==="string"&&aS.parent_field_setting!==""){var aX=aY[aS.parent_field_setting];if(!(Array.isArray(aX))){aY[aS.parent_field_setting]=[aT]}else{aX.push(aT)}}}return aY}function j(){var aS=q.user_card;if(U.is_empty(aS)){return false}if(aS&&aS.roles&&aS.roles.indexOf("&&systemRole")!==-1){return true}if(U.is_empty(B.properties)){return false}var i=H(B.properties);if(!(U.is_empty(i.full_access_role))&&i.full_access_role.value!==""){return aj().indexOf(i.full_access_role.value)!==-1}return false}function aj(){var aS=q.user_card;var i=H(aS);if(U.is_empty(i.assigned_roles)){return[]}if(typeof(i.assigned_roles.value)==="string"){return[i.assigned_roles.value]}if(!(Array.isArray(i.assigned_roles.value))){return[]}return i.assigned_roles.value}function w(i){if(i.indexOf("org.couchdb.user:")===-1){return"org.couchdb.user:"+i}else{return i}}function av(aU){var a0=[];var aV=am(aU,"user");a0.push(w(aV));var aS=H(aU);var aT=al(aU);var aZ=aT.UserDefinition;if(Array.isArray(aZ)){for(var aX=0;aX<aZ.length;aX++){var aY=aS[aZ[aX]];if(Array.isArray(aY.value)){for(var aW=0;aW<aY.value.length;aW++){a0.push(w(aY.value[aW]))}}else{if(typeof(aY.value)==="string"&&aY.value!==""){a0.push(w(aY.value))}}}}return a0}function ah(aS,aW){var aY={};aY=H(aW);var aZ=null;if(!(U.is_empty(aY.show_cards_to_users))){aZ=aY.show_cards_to_users.value}var i=null;if(!(U.is_empty(aY.allow_editing_cards_to_users))){i=aY.allow_editing_cards_to_users.value}var aX=null;if(!(U.is_empty(aY.editor_role))){aX=aY.editor_role.value}var aT=null;if(!(U.is_empty(aY.creator_role))){aT=aY.creator_role.value}var aU={};if(!(U.is_empty(aS.denormalized))){aU=aS.denormalized}var aV={};if(!(U.is_empty(aU[aS.proto_key]))){aV=aU[aS.proto_key]}aV=U.merge(aV,{show_cards_to_users:aZ,editor_role:aX,allow_editing_cards_to_users:i,creator_role:aT});aU[aS.proto_key]=aV;aS.denormalized=aU}function aM(aU,aS){if(typeof(aS)!=="boolean"){aS=false}if(j()){return true}if(U.is_empty(aU)){if(aS){I.log("no proto found and you are not admin - can't create new card",LOG_LEVEL.warning)}return false}var aT=H(aU);var i="";if(!(U.is_empty(aT.editor_role))&&typeof(aT.editor_role.value)==="string"){i=aT.editor_role.value}if(i===""){return true}var aW=aj();if(aW.indexOf(i)!==-1){return true}var aV="";if(!(U.is_empty(aT.creator_role))&&typeof(aT.creator_role.value)==="string"){aV=aT.creator_role.value}if(aV===""){if(aS){I.log("you don't have the creator role - can't create new card",LOG_LEVEL.warning)
}return false}if(aW.indexOf(aV)!==-1){return true}if(aS){I.log("all security checks have failed for you - can't create new card",LOG_LEVEL.warning)}return false}function u(aS,aW,i,aX){var a3=true;var aT=false;var aZ={write_role_members_and_users_related_to_card:0,only_write_role_members:1};if(typeof(i)!=="boolean"){i=true}if(typeof(aX)!=="boolean"){aX=false}if(!(U.is_empty(aS))&&aS.readonly===true){if(i){I.log("the card is readonly - can't edit",LOG_LEVEL.message)}return aT}if(!(U.is_empty(aS))&&aS.persistent===false){if(i){I.log("card not persistent - you can edit",LOG_LEVEL.message)}return a3}if(j()){if(i){I.log("you're admin",LOG_LEVEL.message)}return a3}if(!(U.is_empty(aS))&&aS.definition_type==="User"&&aS._id===q.user_card._id){return a3}if(!(U.is_empty(aS))&&aS.definition_type==="ApplicationProperties"&&typeof(B.application_key)!=="string"){return a3}if(U.is_empty(aW)){if(i){I.log("no proto found, can't edit card",LOG_LEVEL.message)}return aT}if(aX===true){if(i){I.log("new card - checking creation permissions",LOG_LEVEL.message)}return aM(aW,i)}var aU=e(aS,"Editor");if(typeof(aU)==="object"&&Object.keys(aU).length>0){for(var aY in aU){if(aj().indexOf(aY)!==-1){if(i){I.log("one of your roles is listed as card editor role, so you're editor",LOG_LEVEL.message)}return a3}}}var a0=H(aW);var aV="";if(!(U.is_empty(a0.editor_role))&&typeof(a0.editor_role.value)==="string"){aV=a0.editor_role.value}if(aV===""){if(i){I.log("no editor set - you can edit",LOG_LEVEL.message)}return a3}if(aj().indexOf(aV)!==-1){if(i){I.log("you're editor",LOG_LEVEL.message)}return a3}var a1=aZ.write_role_members_and_users_related_to_card;if(!(U.is_empty(a0.allow_editing_cards_to_users))&&typeof(a0.allow_editing_cards_to_users.value)==="number"){a1=a0.allow_editing_cards_to_users.value}if(a1===aZ.only_write_role_members){if(i){I.log("not editable since your roles neither match the applied card writer roles nor the editor role of the relevant proto "+aW._id,LOG_LEVEL.message)}return aT}var a2=q.user_id;if(typeof(a2)!=="string"||a2===""){if(i){I.log("you can't edit the card - no user id found!",LOG_LEVEL.message)}return aT}a2=w(a2);if(!(U.is_empty(aS))&&av(aS).indexOf(a2)!==-1){if(i){I.log("you're a related user and you can edit",LOG_LEVEL.message)}return a3}if(i){I.log("you can't edit the card - all security checks have failed to give you permission",LOG_LEVEL.message)}return aT}function n(aU,aW,i,aX){var aT=true;var a3=false;var a0={all_application_users:0,write_access_users_and_card_read_role_members_and_users_related_to_card:1,only_write_access_users_and_card_read_role_members:2,only_admins:4};if(typeof(i)!=="boolean"){i=true}if(typeof(aX)!=="boolean"){aX=false}if(j()){return a3}if(aU.hidden===true){if(i){I.log("hidden flag is enabled.",LOG_LEVEL.message)}return aT}if(typeof(aU)==="object"&&typeof(aU.definition_type)==="string"&&aU.definition_type==="Proto"){return a3}var aZ={};if(!(U.is_empty(aW))){aZ=H(aW)}var a2=a0.all_application_users;if(typeof(aU.show_cards_to_users)==="number"){a2=aU.show_cards_to_users}if(a2===a0.all_application_users&&!(U.is_empty(aZ.show_cards_to_users))&&typeof(aZ.show_cards_to_users.value)==="number"){a2=aZ.show_cards_to_users.value}var aV="";if(typeof(aU.editor_role)==="string"){aV=aU.editor_role}if(aV===""&&!(U.is_empty(aZ.editor_role))&&typeof(aZ.editor_role.value)==="string"){aV=aZ.editor_role.value}switch(a2){case a0.write_access_users_and_card_read_role_members_and_users_related_to_card:if(aX){return a3}var a1=q.user_id;if(typeof(a1)==="string"&&a1!==""){a1=w(a1);if(av(aU).indexOf(a1)!==-1){return a3}}case a0.only_write_access_users_and_card_read_role_members:if(u(aU,aW,i,aX)){return a3}var aS=e(aU,"Reader");if(typeof(aS)==="object"&&Object.keys(aS).length>0){for(var aY in aS){if(aj().indexOf(aY)!==-1){if(i){I.log("one of your roles is listed as card reader role, so you've access",LOG_LEVEL.message)}return a3}}}if(i){I.log("hidden since you don't have write access for this card and your roles do not match the applied card reader roles",LOG_LEVEL.message)
}return aT;case a0.only_admins:if(aX){return a3}if(i){I.log("this Card is only visible to Administrators",LOG_LEVEL.message)}return aT}return a3}function ay(i){if(i.hidden===true){return true}if(i.show_to_users===4&&!(j())){return true}}function aD(aS){var i="";if(Array.isArray(aS)){i=aS.join()}else{i=String(aS)}return i}function o(aT,a9,a5,ba,a0){var aW=["Text","Number"];if(a9){aW.push("MultilanguageText");aW.push("Relation")}var a7=[];if(Array.isArray(aT.design_elements)&&aT.design_elements.length>0){var aY=H(aT);var a1=0;var aV=null;for(var a6=0;a6<aT.design_elements.length;a6++){var a8=A(aT.design_elements[a6]);aV=U.get_property(a8,"display_priority");if(typeof(aV)!=="number"||a8.deleted===true){aV=0}if(aV>a1){a1=aV}}var aS=-1;while(a7.length<a5&&aT.design_elements.length&&aT.design_elements.length>aS+1){aS++;var aZ=aT.design_elements[aS];if(typeof(aZ)!=="object"||aZ===null){I.log("invalid design element found in related document "+aT._id+" at index "+String(aS),LOG_LEVEL.warning);continue}var a4=A(aZ);if(a4.deleted===true){continue}if(a4.cardinality_setting===2||a4.multiple_values_setting===1||Array.isArray(a4.value)){continue}aV=U.get_property(a4,"display_priority");if(typeof(aV)!=="number"){aV=0}if(aV<a1){continue}if(U.get_property(a4,"user_enabled_setting")===2){continue}identifier=J(aZ);if(typeof(identifier)!=="string"||identifier===""){continue}var aU=U.get_property(a4,"element_type");if(typeof(aU)!=="string"||aW.indexOf(aU)===-1){continue}var a3=aZ.value;if(U.is_empty(a3)){continue}var a2="";if(aU==="MultilanguageText"){a2=l(a3,"",ba)}else{if(aU==="Relation"){var aX=C(a3,false);if(typeof(aX)!=="object"||aX===null){continue}if(aX.deleted===true){continue}a2=aq(aX,false,1,"Parent: ",undefined,ba,false,a0)}else{a2=aD(a3)}}if(a2===""){continue}a7.push(a2)}}return a7}function af(i,aT){var aS=H(i);var aU="";if(aS.shortname!==undefined){aU=aJ(aS.shortname,aT)}if(aU===""&&aS.name!==undefined){aU=aJ(aS.name,aT)}if(aU===""&&aS.plural_name!==undefined){aU=aJ(aS.name,aT)}if(aU===""&&aS.label!==undefined){aU=aJ(aS.label,aT)}return aU}function aq(aU,aV,aT,a1,i,aS,aX){function aW(){var a3=U.get_property(aU.denormalized,aU._id);if(typeof(a3)==="object"&&a3!==null&&typeof(a3.shortname)==="object"&&a3.shortname!==null){aY=aH(a3.shortname,function(a4){return a4},i)[0]}return aY}if(typeof(aU)!=="object"||aU===null){return""}if(aU.definition_type==="ApplicationProperties"){return l(ML_KEYS.application_properties_key,"application properties",i)}if(aU.definition_type==="ImportExportCard"){return l(ML_KEYS.import_export_title_key,"import export",i)}if(typeof(aU.definition_type)==="string"&&aU.definition_type.indexOf("Field")!==-1){return l(a(aU).get_value("label"),"field",i)}var aY="";if(aS!==true){aY=aW();if(aY!==""){return aY}}if(aX===true){var a2=aF(aU);if(U.is_function(a2.get_shortname)){aY=a2.get_shortname(a(aU))}}if(aY!==""){return aY}if(aV===undefined){aV=true}if(aT===undefined){aT=3}if(a1===undefined){a1="Card: "}aY=af(aU,i);if(aY===""){var a0=o(aU,aV,aT,i,aX);aY=a0.join()}if(aY===""){aY=aW();if(aY!==""){return aY}}if(aY===""){var aZ=null;if(aU.proto_key!==undefined){aZ=C(aU.proto_key)}if(typeof(aZ)==="object"&&aZ!==null){aY=af(aZ,i)}}if(typeof(aU.definition_type)==="string"&&aU.definition_type!==""){if(aY===""){aY=aU.definition_type+":"+aU._id}else{aY=aU.definition_type+":"+aY}}if(aY===""){aY=a1+aU._id}return aY}function O(i,aS){if(aS!==true){return i}return l(ML_KEYS.before_first_save_card_save_prefix)+" "+i}function ao(aS,aW,aT){if(aW===undefined){aW=false}var aV="";if(aT===true){var i=aF(aS);if(U.is_function(i.get_title)){aV=i.get_title(a(aS),aW)}}if(aV!==""){return aV}var aU=U.get_property(aS,"title_multilanguage_key");if(typeof(aU)==="string"&&aU!==""){return O(l(aU,"[MultiLanguage Card "+aU+" for title not found]"),aW)}return O(aq(aS,undefined,undefined,undefined,undefined,undefined,aT),aW)}function aI(aW,aT,aV,aS){var aX={};if(!(Array.isArray(aW))){return aX}for(var aU=0;aU<aW.length;aU++){if(typeof(aW[aU])!=="object"||aW[aU]===null||aW[aU]._id===undefined){continue
}aX[aW[aU]._id]=aq(aW[aU],aT,aV,aS,undefined,undefined,true)}return aX}function z(aS,i){if(typeof(i)!=="boolean"){i=true}if(typeof(aS)!=="object"||aS===null||Array.isArray(aS)){I.log("cannot get type of invalid card: "+JSON.stringify(aS),LOG_LEVEL.error);return null}if(i&&typeof(aS._id)==="string"&&aS._id in aO){return z(aO[aS._id],false)}if(!("definition_type" in aS)||aS.definition_type==="DynamicCard"){if(!("proto_key" in aS)){I.log("card with id neither contains a definition type nor a proto key - invalid type; card: "+JSON.stringify(aS));return null}return"DynamicCard"}card_type=aS.definition_type+"Definition";if(!(card_type in Z)){return"DynamicCard"}return card_type}function aw(aV,aT){var a0=z(aV);if(a0==="ProtoDefinition"){var aS=H(aV);var aZ=null;if(typeof(aS.card_design_elements)==="object"&&aS.card_design_elements!==null){aZ=aS.card_design_elements.value}var aU=false;var aX=false;if(Array.isArray(aZ)){for(var aY=0;aY<aZ.length;aY++){var aW=C(aZ[aY],false);if(typeof(aW)!=="object"||aW===null){continue}var a1=z(aW);if(a1==="TableViewDefinition"){aX=true;continue}if(a1==="ButtonDefinition"){continue}aU=true}}if(aU===true){return l(ML_KEYS.data_proto,"Data Proto",aT)}if(aX===true){return l(ML_KEYS.tableview_proto,"Overview Proto",aT)}return l(ML_KEYS.utility_proto,"Utility Proto",aT)}return a0}function S(aU){var aT=[];if(!(Array.isArray(aU))){I.log("cannot heal cards: not in array form",LOG_LEVEL.error)}for(var aS=0;aS<aU.length;aS++){aT.push(aN(aU[aS]))}return aT}function aN(aV,a4,aS){function aT(a6,ba,a9){if(Array.isArray(a6.design_elements)&&Array.isArray(ba)){var a8=H(ba);for(var a7=0;a7<a6.design_elements.length;a7++){if(a6.definition_type==="Log"&&a6.design_elements[a7].value_type==="unicode"&&typeof(a6.design_elements[a7].value)==="string"&&a6.design_elements[a7].value.trim()===""||a6.definition_type!=="Log"&&typeof(a6.design_elements[a7][a9])==="string"&&!(a6.design_elements[a7][a9] in a8)){a6.design_elements[a7].hidden=true}}}}if(typeof(aV)!=="object"||aV===null){return{}}if(typeof(aV._id)!=="string"||aV._id===""){aV._id=U.get_uuid()}if(a4===undefined){a4={}}if(aS===undefined){aS=T}ae(aV);var aW=z(aV);if(aW===null){I.log("cannot heal card - type not recognized",LOG_LEVEL.error);return aV}if(aW==="DynamicCard"&&!("proto_key" in aV)&&aV._id in aO){aV.proto_key=aO[aV._id].proto_key}else{if(aW!=="DynamicCard"&&!("definition_type" in aV)&&aV._id in aO){aV.definition_type=aO[aV._id].definition_type}else{if(aW==="DynamicCard"&&"definition_type" in aV){aV.proto_key=aV.definition_type;delete aV.definition_type;a4.value=true}}}if(typeof(aV.last_healed)==="string"&&aV.last_healed<STRUCTURE_VERSION){ak.migrate_card(a(aV));a4.value=true}var a1=aV;if(typeof(a1.temporary_data)==="object"&&a1.temporary_data!==null){delete a1.temporary_data}if(typeof(a1.denormalized)==="object"&&a1.denormalized!==null&&a1._id in a1.denormalized){delete a1.denormalized[a1._id]}if(aV._id in aO&&(typeof(aV.last_healed)!=="string"||aV.last_healed<STRUCTURE_VERSION)){var aX=aO[aV._id];if(aX.last_healed<STRUCTURE_VERSION){var a5=z(aX);if(a5===null){I.log("template card with unknown type: "+aX._id);a5=aW}aX=U.extend(Z[a5],aX);aX.last_healed=STRUCTURE_VERSION;aO[aV._id]=aX}if(aX.readonly===true){a1=aX}else{aT(aV,aX.design_elements,"name");a1=U.extend(aX,aV)}a1.last_healed=STRUCTURE_VERSION;a4.value=true}else{if(typeof(aV.last_healed)!=="string"||aV.last_healed<STRUCTURE_VERSION){aT(aV,Z[aW].design_elements,"name");a1=U.extend(Z[aW],aV);a1.last_healed=STRUCTURE_VERSION;a4.value=true}}if(aW!=="DynamicCard"){return a1}var a0=aS[aV.proto_key];if(typeof(a0)!=="object"||a0===null){I.log("cannot complete card healing for card "+aV._id+": proto not found or invalid ("+aV.proto_key+")");return a1}ah(a1,a0);var a2=H(a0);if(!("card_design_elements" in a2)){return a1}var a3=a2.card_design_elements.value;if(!(Array.isArray(a3))){I.log("invalid proto: card_design_elements is not a multivalue field: "+String(a2.card_design_elements));return a1}var aU=[];for(var aZ=0;aZ<a3.length;
aZ++){var aY=C(a3[aZ]);if(typeof(aY)!=="object"||aY===null||aY.deleted===true){continue}aU.push({definition_key:a3[aZ],value:""})}aT(a1,aU,"definition_key");a1.design_elements=U.extend(aU,a1.design_elements);return a1}function aK(aU){var a1={};switch(aU.definition_type){case"RelationField":case"UserRelationField":case"ReaderRoleField":case"EditorRoleField":case"TableView":var a0=H(aU);var aT=aU.parent_application_setting;if(typeof(aT)!=="string"||aT===""){aT=aU.application_setting}if(typeof(aT)!=="string"||aT===""){aT=U.get_property(a0.parent_application_setting,"value")}if(typeof(aT)!=="string"||aT===""){aT=U.get_property(a0.application_setting,"value")}if(typeof(aT)==="string"&&aT!==""){a1.parent_application_id=aT}}var aX=ar("&&multilanguageProto");var aZ=H(aX);var aV=aZ.card_design_elements.value;var aW={};var a2={};for(var aY=0;aY<aV.length;aY++){aW[aV[aY]]=aq(aU,undefined,undefined,undefined,aV[aY],true,true);var aS=aw(aU,aV[aY]);if(typeof(aS)!=="string"||aS===""){I.log("could not determine type in language "+aV[aY]+" for card "+JSON.stringify(aU));a2[aV[aY]]="n/a"}else{a2[aV[aY]]=aw(aU,aV[aY])}}a1.shortname=aW;a1.displayable_type=a2;return a1}function aA(aT,a0){function aX(a4,a2,i){var a3=null;if(typeof(i)==="string"&&i!==""){a3={parent_application_id:i}}else{var a1=C(a4,false);if(typeof(a1)!=="object"||a1===null){return}a3=aK(a1)}if(U.is_empty(a3)){I.log("no denormalized data could be extracted from card "+a4+" in order to update denormalized data for "+a2._id);return}if(typeof(a2.denormalized)!=="object"||a2.denormalized===null){a2.denormalized={}}a2.denormalized[a4]=a3}if(typeof(aT)!=="object"||aT===null){I.log("card has invalid type, cannot update denormalized data: "+String(aT),LOG_LEVEL.error);return}if(typeof(a0)!=="boolean"){a0=false}var aV=aK(aT);if(typeof(aT.denormalized)!=="object"||aT.denormalized===null){aT.denormalized={}}aT.denormalized[aT._id]=aV;if(a0===true||z(aT)!=="DynamicCard"){return}for(var aY=0;aY<aT.design_elements.length;aY++){var aZ=aT.design_elements[aY];if(typeof(aZ.definition_key)!=="string"||aZ.definition_key===""){continue}var aW=C(aZ.definition_key);if(typeof(aW)!=="object"||aW===null||aW.deleted===true){continue}if(["RelationField","UserRelationField","EditorRoleField","ReaderRoleField"].indexOf(aW.definition_type)===-1){continue}aX(aZ.definition_key,aT);relation_field_denormalized_data=U.get_property(aT.denormalized,aZ.definition_key);var aS=null;if(!(U.is_empty(relation_field_denormalized_data))&&typeof(relation_field_denormalized_data.parent_application_id)==="string"&&relation_field_denormalized_data.parent_application_id!==""&&relation_field_denormalized_data.parent_application_id!==B.application_key){aS=relation_field_denormalized_data.parent_application_id}if(typeof(aZ.value)==="string"&&aZ.value!==""){aX(aZ.value,aT,aS)}else{if(Array.isArray(aZ.value)){for(var aU=0;aU<aZ.value.length;aU++){aX(aZ.value[aU],aT,aS)}}else{if(aZ.value!==""){I.log("design element value neither string nor array - cannot denormalize : "+JSON.stringify(aZ.value))}}}}}function f(aU){var aS={};for(var aV=0;aV<aU.design_elements.length;aV++){value=aU.design_elements[aV].value;if(value===undefined){continue}if(!(Array.isArray(value))&&typeof(value)==="object"){continue}if(Array.isArray(value)){for(var aT=0;aT<value.length;aT++){aS[String(value[aT])]=""}}else{aS[String(value)]=""}}return aS}function aE(aS,aW){if(typeof(aS)!=="object"||aS===null){I.log("card is of invalid type, cannot update relating cards: "+String(aS),LOG_LEVEL.error);return null}if(!(Array.isArray(aW))){I.log("relating cards are not of array type, cannot update denormalization",LOG_LEVEL.error);return null}if(typeof(aS.definition_type)==="string"&&aS.definition_type.indexOf("Field")!==-1){var aU=null;for(var aV=0;aV<aW.length;aV++){if(aW[aV].definition_type==="Proto"){aU=aW[aV];break}}if(aU===null){I.log("cannot update denormalization of proto - proto not found as a relating card when saving field "+aS._id)}var aY=H(aU);var aZ=[];if(Array.isArray(aY.card_design_elements.value)){aZ=aY.card_design_elements.value
}if(aZ.indexOf(aS._id)===-1){aZ.push(aS._id)}}var aX=[];for(var aV=0;aV<aW.length;aV++){var a2=aW[aV];var aT=f(a2);if(a2.proto_key!=undefined){aT[a2.proto_key]=""}aT[a2._id]="";if(aS._id in aT){aX.push(a2)}}var a0=aK(aS);var a1=[];if(!(U.is_empty(a0))){for(var aV=0;aV<aX.length;aV++){if(U.is_empty(aX[aV].denormalized)){aX[aV].denormalized={}}aX[aV].denormalized[aS._id]=U.clone(a0,false);aA(aX[aV],true);G(aX[aV]);a1.push(aX[aV])}}return a1}function ar(i){var aS=C(i);if(aS===null){I.log("proto is missing in this application: "+i,LOG_LEVEL.error);return null}if(aS.definition_type!=="Proto"){I.log("invalid definition type in proto: "+aS.definition_type,LOG_LEVEL.error);return null}return aS}function t(aT){var aS="";var i=Date.parse(aT);if(isNaN(i)){I.log("The following value could not be interpreted as a date: "+aT,LOG_LEVEL.message);return aS}var aU=new Date(i);return aU.toISOString()}function aL(aS,aV){if(typeof(aS)!=="object"||aS===null){I.log("card has invalid type, cannot apply posted form: "+String(aS),LOG_LEVEL.error);return null}if(typeof(aV)!=="object"||aV===null){I.log("posted form has invalid type, cannot apply to card: "+String(aV),LOG_LEVEL.error);return aS}var a0=U.clone(aS);if(!(Array.isArray(aS.design_elements))){return a0}for(var aT=0;aT<a0.design_elements.length;aT++){var aU=a0.design_elements[aT];var aW=J(aU);var aX=A(aU);if(aX.creates_value===false){continue}if((aX.multiple_values_setting===1||aX.cardinality_setting===2)&&aX.value_type!=="key"){I.log(aW+": multiple values setting is only supported with value_type 'key'",LOG_LEVEL.error);continue}var aZ=null;var aY=aV[aW];if(aY===undefined&&(aX.multiple_values_setting===1||aX.cardinality_setting===2)){continue}if(aY===undefined){continue}if(aX.multiple_values_setting===1||aX.cardinality_setting===2){if(Array.isArray(aY)){aZ=aY}else{if(typeof(aY)==="string"&&aY!==""){aZ=aY.split(",")}else{if(aY===""){aZ=[]}else{I.log(aW+": unrecognised value format for multivalue key",LOG_LEVEL.error)}}}}else{switch(aX.value_type){case"unicode":case"key":aZ=String(aY);break;case"date":aZ="";if(typeof(aY)==="string"&&aY!==""){aZ=t(aY)}break;case"number":if(aY===""||aY===null){aZ=null}else{if(isNaN(Number(aY))){aZ=String(aY)}else{aZ=Number(aY)}}break;case"boolean":if(aY==="Yes"||aY===true){aZ=true}else{aZ=false}break;default:aZ=String(aY)}}aU.value=aZ}return a0}function m(i){return/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/i.test(i)}function v(i){var aS=[];if(!(U.is_empty(i))&&!(U.is_empty(i.modification_log))){aS=i.modification_log}return aS}function b(aU,aS){var aV="";var i=null;var aW=v(aU);var aT=aW.length;if(aT>0){i=aW[aT-1];aV=U.get_property(i,aS);if(U.is_empty(aV)){aV=""}}return aV}function am(aT,aS){var aU="";var i=null;var aV=v(aT);if(aV.length>0){i=aV[0];aU=U.get_property(i,aS);if(U.is_empty(aU)){aU=""}}return aU}function Y(aV,aX){var aS=[];for(var aT=0;aT<aV.length;aT++){var aW=false;for(var aU=0;aU<aX.length;aU++){if(aV[aT]._id===aX[aU]._id){aW=true;break}}if(aW===false){aS.push(aV[aT])}}return aS}function aa(aV,bd,br,aX){function bk(bv){var bu={};for(var bw=0;bw<bv.length;bw++){aA(bv[bw],true);G(bv[bw]);if(bv[bw].readonly===true&&"user_id" in q&&q.user_id!=="system_and_support"){continue}bu[bv[bw]._id]=bv[bw]}return bu}aV=a(aV);if(!("_id" in aV)){return bk(ai)}var aT=aL(aV,bd);var a2=aF(aT);if(U.is_function(a2.on_save)){a2.on_save(a(aT),br,aX)}var a6=[];var a7=H(aV);var bg=H(aT);if(!(Array.isArray(aV.design_elements))){aA(aT);a6.push(aT);return bk(a6.concat(Y(ai,a6)))}for(var aY in bg){var bb=bg[aY];var i=A(bb);var aZ=U.get_property(a7[aY],"value");var bc=U.get_property(bg[aY],"value");switch(i.element_type){case"MultilanguageText":if((typeof(aZ)!=="string"||aZ===""||!(m(aZ)||aZ.indexOf("&&mlkey")!==-1)||aZ!==bc)&&bc!==""&&!(m(bc))){var aU=k();var ba=ar("&&multilanguageProto");if(ba===null){I.log("could not get multilanguage proto card for this application - aborting multilanguage card save.",LOG_LEVEL.error);continue}var a8=H(ba);if(!("card_design_elements" in a8)||a8.card_design_elements.value.indexOf(aU)===-1){ba=aN(ba);
a8=H(ba);a8.card_design_elements.value.push(aU);T["&&multilanguageProto"]=ba;a6.push(ba);language_field_definition_card=aN({_id:aU,definition_type:"TextField",design_elements:[{name:"grid_size_setting",value:1},{name:"number_of_lines_setting",value:1}]});T[aU]=language_field_definition_card;a6.push(language_field_definition_card)}var bm=U.get_uuid();var bs=aN({_id:bm,proto_key:"&&multilanguageProto"});var a5=H(bs);a5[aU].value=bc;T[bm]=bs;a6.push(bs);bg[aY].value=bm}break}}if(aT.definition_type==="RelationField"){var bl=H(aT);var bt=0;if(!(U.is_empty(bl.presentation_setting))){bt=bl.presentation_setting.value}switch(bt){case 1:bl.cardinality_setting.value=2;bl.allow_new_cards.value=false;break;case 2:bl.cardinality_setting.value=2;bl.allow_new_cards.value=true;break;default:bl.cardinality_setting.value=1;bl.allow_new_cards.value=false}}else{if(aT.definition_type==="ApplicationProperties"){var bh=aT.get_value("languages");var a0=C("&&multilanguageProto");if(!(U.is_empty(a0))){var aS=a0.get_value("card_design_elements");var bi=false;if(JSON.stringify(bh)!==JSON.stringify(aS)){bi=true}for(var bq=0;bq<bh.length;bq++){if(aS.indexOf(bh[bq])===-1){var a9={_id:bh[bq],design_elements:[{name:"grid_size_setting",value:1},{name:"number_of_lines_setting",value:1}]};a9.__proto__=Z.TextFieldDefinition;T[bh[bq]]=a9;a6.push(a9);bi=true}}if(bi){if(!(a0.set_design_element_value("card_design_elements",bh,false))){I.log("could not add a language - element on multilanguage proto card not found",LOG_LEVEL.error)}else{T["&&multilanguageProto"]=a0;a6.push(a0)}}}}else{if(aT.definition_type==="Proto"&&br===true){var bf=bg.cards_based_on_this;if(typeof(bf)==="object"&&bf!==null){bf.application_setting=B.application_key;bf.entity_proto_setting=aT._id}else{I.log("cards tableview not found in proto")}var bp=U.get_property(bg.plural_name,"value");if(typeof(bp)!=="string"||bp===""){bp=U.get_property(bg.name,"value")}if(typeof(bp)!=="string"||bp===""){bp=ML_KEYS.new_tableview_key}var aW=aN({definition_type:"TableView",design_elements:[{name:"application_setting",value:B.application_key},{name:"entity_proto_setting",value:aT._id},{name:"label",value:bp}]});T[aW._id]=aW;a6.push(aW);var be=U.get_uuid();var a4=aN({_id:be,definition_type:"Proto",design_elements:[{name:"name",value:bp},{name:"card_design_elements",value:[aW._id]}]});var a3=H(a4);a3.cards_based_on_this.application_setting=B.application_key;a3.cards_based_on_this.entity_proto_setting=a4._id;T[a4._id]=a4;a6.push(a4);var bj=bg.automatically_created_tableview_proto;bj.hidden=false;bj.value=be;var bn=aN({proto_key:be,automatically_created_for_proto:aT._id});T[bn._id]=bn;a6.push(bn);var bo=C("&&userMenuDefinition",false);if(U.is_empty(bo)){bo=aN({_id:"&&userMenuDefinition",definition_type:"Menu"});T[bo._id]=bo;a6.push(bo);application_properties=C("&&applicationProperties");if(U.is_empty(application_properties)){I.log("no application properties found in related cards, cannot properly initialize Proto",LOG_LEVEL.error)}else{application_properties_index=H(application_properties);menus=U.get_property(application_properties_index.menu_definitions,"value");if(!Array.isArray(menus)){I.log("invalid menus list in application properties, cannot properly initialize Proto",LOG_LEVEL.error)}else{menus.push(bo._id);a6.push(application_properties)}}}user_menu_definition_index=H(bo);entries=U.get_property(user_menu_definition_index.menu_entries,"value");if(!Array.isArray(entries)){I.log("invalid menu entry list in user menu definition, cannot properly initialize Proto",LOG_LEVEL.error)}else{entries.push(bn._id);a6.push(bo)}}}}aA(aT);a6.unshift(aT);var a1=bk(a6.concat(Y(ai,a6)));return a1}function s(aU,aV){for(var aT=0;aT<aV.length;aT++){var aS=J(aV[aT]);if(aV[aT]!==aU[aS]){return false}if(aV[aT].value!==aU[aS].value){return false}}return true}function H(aU){if(typeof(aU)!=="object"||aU===null){return{}}var aX=null;var aT=null;var aW=null;if(!(Array.isArray(aU))){aT=aU;aW=U.get_property(aU.temporary_data,"element_index");aX=aT.design_elements;
if(typeof(aW)==="object"&&aW!==null){return aW}}else{aX=aU}if(!(Array.isArray(aX))){return{}}aW={};for(var aV=0;aV<aX.length;aV++){if(typeof(aX[aV])!=="object"||aX[aV]===null||(Array.isArray(aX[aV]))){continue}var aS=J(aX[aV]);if(aS===null){continue}aW[aS]=aX[aV]}if(aT!==null&&"temporary_data" in aT){aT.temporary_data.element_index=aW}else{if(aT!==null){aT.temporary_data={element_index:aW}}}return aW}function J(i){if(typeof(i)!=="object"||i===null){I.log("cannot get identifier - design element is not an object",LOG_LEVEL.error);return null}if("definition_key" in i){return i.definition_key}if("name" in i){return i.name}I.log("cannot get identifier - no 'name' or 'definition_key' property in design element",LOG_LEVEL.error);return null}function x(i){if(typeof(i)!=="object"||i===null){I.log("cannot get identifier - design element properties is not an object",LOG_LEVEL.error);return null}if("definition_key" in i){return i.definition_key}if("name" in i){return i.name}I.log("cannot get identifier - no 'name' or 'definition_key' property in properties: "+JSON.stringify(i),LOG_LEVEL.error);return null}function aJ(i,aU){var aS=A(i);if(aS.element_type=="MultilanguageText"){return l(i.value,"",aU)}if(aS.value_type=="key"){var aT=C(i.value);if(!(U.is_empty(aT))){return aq(aT)}else{return""}}return i.value}function e(aX,aW){var aU={};if(aX!==null&&typeof(aX)==="object"&&!(U.is_empty(aX))&&Array.isArray(aX.design_elements)&&aX.design_elements.length>0){for(var aY=0;aY<aX.design_elements.length;aY++){var aZ=aX.design_elements[aY].value;var aV=A(aX.design_elements[aY]);var aT=U.get_property(aV,"definition_type");var aS=U.get_property(aV,"deleted");if(aS!==true&&aT===(aW+"RoleField")&&typeof(aZ)==="string"&&aZ!==""){aU[aZ]=aZ}}}return aU}function X(aU){var aS=A(aU);var i=U.get_property(aS,"label");if(typeof(i)!=="string"||i===""){i=U.get_property(aS,"label_multilanguage_key")}var aT=l(i,"");if(aT===""){aT=J(aU)}return aT}function A(aS){if(typeof(aS)!=="object"||aS===null||Array.isArray(aS)){I.log("cannot retrieve properties - invalid design element: "+String(aS),LOG_LEVEL.warning);return{}}var aW=null;var aV=null;if("definition_key" in aS){aV=aS.definition_key;aW=C(aV,false)}var i={definition_card:aW};if(!(U.is_empty(aW))){if(aW.deleted===true){i.deleted=true;return i}for(var aT in aW){if(aT==="_id"||aT==="design_elements"||aT==="modification_log"||aT==="denormalized"){continue}i[aT]=aW[aT]}if(Array.isArray(aW.design_elements)){aW.design_element_index=H(aW);for(var aU in aW.design_element_index){i[aU]=aW.design_element_index[aU].value}}}for(var aX in aS){i[aX]=aS[aX]}return i}function h(i){if(typeof(i)!=="object"||i===null){return[]}return Object.keys(i)}function g(aS,i){var aT={key:aS,proto_key:i};return aN(aT)}function at(aS,i){var aT={key:aS,definition_type:i};return aN(aT)}function C(aT,aU,i){if(aU===undefined){aU=true}var aS=T;if(typeof(i)==="object"&&i!==null){aS=i}if(typeof(aT)!=="string"||aT===""||aT==="$$$"){if(aU){I.log("cannot resolve card for invalid key: "+String(aT))}return null}else{if(aT in aS){return a(aS[aT])}else{if(aT.indexOf("Definition")!==-1&&Z[aT]!==undefined){return a(U.clone(Z[aT]))}else{if("org.couchdb.user:"+aT in aS){return a(aS["org.couchdb.user:"+aT])}else{if(aU){I.log("cannot resolve key from cards given in context: "+String(aT))}}}}}return null}function k(){if(K!==null){return K}var aU=C("&&multilanguageProto");if(typeof(aU)!=="object"||aU===null){I.log("ML Proto not found, cannot determine active language");K="en";return K}var aX=aU.get_value("card_design_elements");if(!(Array.isArray(aX))){I.log("Invalid ML Proto, cannot determine active language");K="en";return K}if(aX.length===0){K="en";return K}var aW=U.get_property(q,"languages");if(!(Array.isArray(aW))){K=aX[0];return K}for(var aV=0;aV<aW.length;aV++){if(aX.indexOf(aW[aV])!==-1){K=aW[aV];return K}var aS=aW[aV].split("_");if(aS.length<2){continue}for(var aT=aS.length-1;aT>=1;aT--){var i=aS.slice(0,aT).join("_");if(aX.indexOf(i)!==-1){K=i;return K}}}K=aX[0];
return K}function aH(aY,a0,aS){var aV=null;if(typeof(aS)==="string"&&aS!==""){aV=[aS]}else{aV=U.get_property(q,"languages")}var a5="";if(Array.isArray(aV)){for(var a1=0;a1<aV.length;a1++){if(aV[a1] in aY){a5=a0(aY[aV[a1]])}if(typeof(a5)==="string"&&a5!==""){return[a5,aV[a1]]}var aT=aV[a1].split("_");if(aT.length<2){continue}for(var aW=aT.length-1;aW>=1;aW--){var aU=aT.slice(0,aW).join("_");if(aU in aY){a5=a0(aY[aU])}if(typeof(a5)==="string"&&a5!==""){return[a5,aU]}}}}var a2=C("&&multilanguageProto");if(typeof(a2)==="object"&&a2!==null){var a4=a2.get_value("card_design_elements");if(Array.isArray(a4)){for(var aX=0;aX<a4.length;aX++){var aZ=a4[aX];if(aZ in aY){a5=a0(aY[aZ])}if(typeof(a5)==="string"&&a5!==""){return[a5,aZ]}}}}if("en" in aY){a5=a0(aY.en)}if(typeof(a5)==="string"&&a5!==""){return[a5,"en"]}if("en_US" in aY){a5=a0(aY.en_US)}if(typeof(a5)==="string"&&a5!==""){return[a5,"en_US"]}var a3=Object.keys(aY);if(a3.length>0){a5=a0(aY[a3[0]])}return[a5,a3[0]]}function y(aW,aU){if(typeof(aW)!=="boolean"){aW=false}if(!(Array.isArray(aU))){aU=[]}var aS=Object.keys(LANGUAGE_BY_LOCALE);if(!aW){return aS}var i=[];for(var aT=0;aT<aS.length;aT++){var aV=aS[aT].split("_");if(aV.length>1&&aU.indexOf(aV[0])===-1){continue}i.push(aS[aT])}return i}function an(aS){var i=C(aS,false);if(i!==null){i.design_element_index=H(i);return aH(i.design_element_index,function(aT){return aT.value})}return["",null]}function l(aU,aV,aT){var i="";var aS=C(aU,false);if(aS!==null){aS.design_element_index=H(aS);i=aH(aS.design_element_index,function(aW){return aW.value},aT)[0]}if(i!==""){return i}if(aV!==undefined){return aV}else{I.log("cannot get multilanguage text for key from cards given in context: "+String(aU));return"[Missing Multilanguage Text]"}}function aF(aS){if(U.is_empty(aS)||aS.definition_type==="Proto"){return{}}var i=aS.proto_key;var aT=null;if(typeof(i)==="string"){aT=C(i)}if(typeof(script_libraries_by_applicable_key)!=="object"){return{}}if(!(U.is_empty(script_libraries_by_applicable_key[aS._id]))){return script_libraries_by_applicable_key[aS._id]}if(!(U.is_empty(aT))&&!(U.is_empty(script_libraries_by_applicable_key[aT._id]))){return script_libraries_by_applicable_key[aT._id]}return{}}function D(aT){if(Array.isArray(aT.value)){return aT.value}if(aT.value===""){return[]}var aS=x(aT);var i="design element "+aS+": expected value is an array of "+aT.value_type+", but is of simple type "+typeof(aT.value);switch(aT.value_type){case"boolean":I.log(i);if(typeof(aT.value)==="boolean"){return[aT.value]}break;case"number":I.log(i);if(typeof(aT.value)==="number"){return[aT.value]}if(typeof(aT.value)==="boolean"){return[Number(aT.value)]}break;case"unicode":case"date":I.log(i);if(typeof(aT.value)==="string"&&aT.value!==""){return[aT.value]}if(typeof(aT.value)==="number"){return[String(aT.value)]}break;case"key":if(typeof(aT.value)==="string"&&aT.value!==""){return aT.value.split(",")}break}return[]}function ag(aT){var aS=x(aT);var i="design element "+aS+": expected value is of type "+aT.value_type+", but is of type "+typeof(aT.value);switch(aT.value_type){case"boolean":if(typeof(aT.value)==="boolean"){return aT.value}I.log(i);return false;case"number":if(aT.value===null){return""}if(typeof(aT.value)==="number"||typeof(aT.value)==="string"){return aT.value}I.log(i);if(typeof(aT.value)==="boolean"){return Number(aT.value)}break;case"unicode":if(typeof(aT.value)==="string"){return aT.value}I.log(i);if(typeof(aT.value)==="number"){return String(aT.value)}break;case"key":case"date":if(typeof(aT.value)==="string"){return aT.value}if(Array.isArray(aT.value)){return aT.value[0]}I.log(i);break;case"attachment":if(typeof(aT.value)==="object"&&aT.value!==null&&!(Array.isArray(aT.value))){return aT.value}return{}}return""}function V(i){if(i.multiple_values_setting===1||i.cardinality_setting===2){return D(i)}return ag(i)}function Q(i){var aS=U.get_property(i,"definition_type");if(typeof(aS)==="string"&&aS!==""){return aS}if(typeof(i.automatically_created_for_proto)==="string"&&i.automatically_created_for_proto!==""){return i.automatically_created_for_proto
}aS=U.get_property(i,"proto_key");if(typeof(aS)==="string"&&aS!==""){return aS}return null}function ax(a2,a0,aX,a8){var bc={};if(typeof(a2)!=="object"||a2===null){a2={}}var a5={};for(var ba=0;ba<a0.length;ba++){a0[ba]=a(a0[ba])}for(var a9=0;a9<a0.length;a9++){var aS=a0[a9]._id;if(typeof(aS)!=="string"||aS===""){I.log("no _id in healed Card. i: "+a9+", length: "+a0.length+", healed Card: "+JSON.stringify(a0[a9]));continue}var aW=aa(a0[a9],posted_form,a8,validation_errors);bc=U.merge(bc,aW);var a4=C(aS,false,bc);if(typeof(a4)!=="object"||a4===null){continue}a5=validator.get_validation_errors(a4,validation_errors);if(!(U.is_empty(a5))){break}for(var a7=0;a7<aX.length;a7++){var bb=aX[a7]._id;var aU=C(bb,false,bc);if(typeof(aU)==="object"&&aU!==null){aX[a7]=aU}}var a3=aE(a4,aX);if(Array.isArray(a3)){for(var a7=0;a7<a3.length;a7++){bc[a3[a7]._id]=a3[a7]}}}var aY=null;var aZ=[];if(U.is_empty(a5)){aY=[];var aV=null;for(var a1 in bc){if(a1!==a0[0]._id&&a1!=="org.couchdb.user:"+a0[0]._id){aY.push(bc[a1]);aZ.push(a1)}else{aV=a1}}if(aV!==null){aY.unshift(bc[aV]);aZ.unshift(aV)}}else{var a6="";for(var aT in a5){a2[aT]=a5[aT];if(a6!==""){a6+="; "}a6+=a5[aT]}if(I.log_card.number_of_entries===0){I.log(tools.get_multilanguage_string(ML_KEYS.validation_error_default,"validation errors present:").trim()+" "+a6,LOG_LEVEL.message)}}return aY}var M={cleanup_card_for_storage:G,template_cards_by_key:aO,related_cards_by_key:T,get_template_card_keys:aR,get_cards_needing_update:ap,get_family_of_user_creatables:aB,get_design_element_properties_by_name:aG,get_relation_field_ids_associated_to_proto_by_proto_key:al,get_value_from_last_modification_log_entry:b,get_value_from_first_modification_log_entry:am,get_short_representation:aq,get_short_representations_by_key:aI,get_title:ao,get_card_type:z,get_displayable_card_type:aw,get_healed_cards:S,get_healed_card:aN,get_relating_cards_with_updated_denormalized_data:aE,get_user_role_keys:aj,get_attachment_names:h,is_current_user_admin:j,are_new_cards_creatable:aM,is_card_editable:u,is_uuid:m,is_card_hidden:n,is_design_element_hidden:ay,get_card_with_posted_form_applied_by_value_type:aL,get_updated_and_new_cards_by_id:aa,get_element_index:H,get_design_element_identifier:J,get_design_element_identifier_from_properties:x,get_design_element_properties:A,get_static_design_element_content:aJ,get_design_element_label:X,create_dynamic_card:g,create_static_card:at,resolve_key:C,get_active_language:k,get_available_locales:y,get_multilanguage_string_and_language_from_object_indexed_by_language:aH,get_multilanguage_string_and_language:an,get_multilanguage_string:l,get_script_library:aF,get_responded_value_from_design_element_properties:V,get_definition:Q,get_updated_cards_and_validation_errors:ax,monkey_patch_card:a};var aP={};var L=Object.keys(M);for(var R=0;R<L.length;R++){var ad=M[L[R]];if(typeof(E)==="object"&&E!==null){aP[L[R]]=E.profile(ad)}else{aP[L[R]]=ad}}return aP};